name: "ğŸ”§ ìë™ ë¦¬íŒ©í† ë§ - íˆ¬ì ì „ëµ ë³´ì¡´"

on:
  workflow_dispatch:
    inputs:
      refactor_level:
        description: 'ë¦¬íŒ©í† ë§ ìˆ˜ì¤€'
        required: true
        default: 'safe'
        type: choice
        options:
        - safe      # ì•ˆì „í•œ ìˆ˜ì¤€ (í¬ë§·íŒ…, import ì •ë¦¬)
        - moderate  # ì¤‘ê°„ ìˆ˜ì¤€ (í•¨ìˆ˜ ë¶„ë¦¬, ì¤‘ë³µ ì œê±°)
        - advanced  # ê³ ê¸‰ ìˆ˜ì¤€ (êµ¬ì¡° ê°œì„ , íŒ¨í„´ ì ìš©)
      
      preserve_strategies:
        description: 'íˆ¬ì ì „ëµ ë³´ì¡´ ì—¬ë¶€'
        required: true
        default: true
        type: boolean

  schedule:
    - cron: '0 3 * * 0'  # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 3ì‹œ (UTC) ìë™ ì‹¤í–‰

env:
  PYTHON_VERSION: '3.11'
  REFACTOR_REPORT_PATH: 'reports/refactor_analysis.md'

jobs:
  analyze_and_refactor:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ ê°œë°œ ë„êµ¬ ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          pip install black isort pylint mypy bandit
          pip install -r requirements.txt
          
          # ë¦¬íŒ©í† ë§ ë„êµ¬ ì„¤ì¹˜
          pip install rope autoflake unify vulture

      - name: ğŸ” íˆ¬ì ì „ëµ í•¨ìˆ˜ ì‹ë³„
        id: identify_strategies
        run: |
          python -c "
          import ast
          import os
          from pathlib import Path
          
          # íˆ¬ì ì „ëµ ê´€ë ¨ í•¨ìˆ˜/í´ë˜ìŠ¤ ì‹ë³„
          strategy_patterns = [
              'buffett', 'warren', 'graham', 'lynch', 'dalio',
              'technical_analysis', 'strategy', 'indicator',
              'rsi', 'macd', 'bollinger', 'moving_average',
              'momentum', 'volatility', 'trend'
          ]
          
          protected_items = set()
          
          for py_file in Path('src').rglob('*.py'):
              try:
                  with open(py_file, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  tree = ast.parse(content)
                  
                  for node in ast.walk(tree):
                      if isinstance(node, (ast.FunctionDef, ast.ClassDef)):
                          name = node.name.lower()
                          if any(pattern in name for pattern in strategy_patterns):
                              protected_items.add(f'{py_file}:{node.lineno}:{node.name}')
                              print(f'ğŸ›¡ï¸ ë³´í˜¸ëœ ì „ëµ ìš”ì†Œ: {py_file}:{node.name}')
              
              except Exception as e:
                  print(f'âš ï¸ íŒŒì¼ ë¶„ì„ ì‹¤íŒ¨ {py_file}: {e}')
          
          # ë³´í˜¸ ëª©ë¡ì„ íŒŒì¼ë¡œ ì €ì¥
          with open('protected_strategies.txt', 'w') as f:
              for item in sorted(protected_items):
                  f.write(item + '\\n')
          
          print(f'âœ… ì´ {len(protected_items)}ê°œ ì „ëµ ìš”ì†Œ ì‹ë³„ ì™„ë£Œ')
          "

      - name: ğŸ”§ ì•ˆì „í•œ ìë™ ë¦¬íŒ©í† ë§
        run: |
          echo "ğŸ”§ ë¦¬íŒ©í† ë§ ìˆ˜ì¤€: ${{ github.event.inputs.refactor_level || 'safe' }}"
          
          # 1. Import ì •ë¦¬ (ì•ˆì „)
          echo "ğŸ“š Import ì •ë¦¬ ì¤‘..."
          isort src/ --profile black --diff --check-only || isort src/ --profile black
          
          # 2. ì½”ë“œ í¬ë§·íŒ… (ì•ˆì „) 
          echo "ğŸ¨ ì½”ë“œ í¬ë§·íŒ… ì¤‘..."
          black src/ --diff --check || black src/
          
          # 3. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” import ì œê±° (ì•ˆì „)
          echo "ğŸ—‘ï¸ ë¶ˆí•„ìš”í•œ import ì œê±° ì¤‘..."
          autoflake --remove-all-unused-imports --remove-unused-variables --in-place --recursive src/
          
          # 4. ì¤‘ê°„ ìˆ˜ì¤€ ë¦¬íŒ©í† ë§ (ì¡°ê±´ë¶€)
          if [[ "${{ github.event.inputs.refactor_level }}" == "moderate" || "${{ github.event.inputs.refactor_level }}" == "advanced" ]]; then
            echo "ğŸ”„ ì¤‘ê°„ ìˆ˜ì¤€ ë¦¬íŒ©í† ë§ ì‹œì‘..."
            
            # ë¬¸ìì—´ ë”°ì˜´í‘œ í†µì¼
            unify --in-place --recursive src/
            
            # ë°ë“œ ì½”ë“œ ì œê±° (ì „ëµ í•¨ìˆ˜ ì œì™¸)
            python -c "
            import subprocess
            import os
            
            # ë³´í˜¸ëœ ì „ëµ ìš”ì†Œ ë¡œë“œ
            protected = set()
            if os.path.exists('protected_strategies.txt'):
                with open('protected_strategies.txt', 'r') as f:
                    protected = set(line.strip() for line in f)
            
            print(f'ğŸ›¡ï¸ ë³´í˜¸ëœ ìš”ì†Œ ìˆ˜: {len(protected)}')
            
            # vultureë¡œ ë°ë“œ ì½”ë“œ íƒì§€ (ë³´ê³ ì„œë§Œ)
            result = subprocess.run(['vulture', 'src/', '--min-confidence', '80'], 
                                  capture_output=True, text=True)
            
            print('ğŸ“Š ë°ë“œ ì½”ë“œ ë¶„ì„ ê²°ê³¼:')
            print(result.stdout if result.stdout else 'âœ… ë°ë“œ ì½”ë“œ ì—†ìŒ')
            "
          fi
          
          # 5. ê³ ê¸‰ ìˆ˜ì¤€ ë¦¬íŒ©í† ë§ (ì¡°ê±´ë¶€)
          if [[ "${{ github.event.inputs.refactor_level }}" == "advanced" ]]; then
            echo "ğŸš€ ê³ ê¸‰ ìˆ˜ì¤€ ë¦¬íŒ©í† ë§ ì‹œì‘..."
            
            # Ropeë¥¼ ì‚¬ìš©í•œ êµ¬ì¡°ì  ë¦¬íŒ©í† ë§ (ì½ê¸° ì „ìš© ë¶„ì„)
            python -c "
            from rope.base.project import Project
            from rope.contrib.autoimport import AutoImport
            import os
            
            try:
                project = Project('.')
                
                # í”„ë¡œì íŠ¸ êµ¬ì¡° ë¶„ì„
                for root in project.get_children():
                    if root.is_folder() and root.name == 'src':
                        for child in root.get_children():
                            if child.name.endswith('.py'):
                                print(f'ğŸ“ ë¶„ì„: {child.path}')
                
                project.close()
                print('âœ… êµ¬ì¡° ë¶„ì„ ì™„ë£Œ')
                
            except Exception as e:
                print(f'âš ï¸ ê³ ê¸‰ ë¶„ì„ ì œí•œë¨: {e}')
            "
          fi

      - name: ğŸ” ë¦¬íŒ©í† ë§ í›„ í’ˆì§ˆ ê²€ì‚¬
        run: |
          echo "ğŸ” ë¦¬íŒ©í† ë§ í›„ í’ˆì§ˆ ê²€ì‚¬..."
          
          # êµ¬ë¬¸ ê²€ì‚¬
          python -c "
          import os
          import py_compile
          from pathlib import Path
          
          errors = []
          for py_file in Path('src').rglob('*.py'):
              try:
                  py_compile.compile(py_file, doraise=True)
                  print(f'âœ… {py_file}: êµ¬ë¬¸ ê²€ì‚¬ í†µê³¼')
              except Exception as e:
                  print(f'âŒ {py_file}: êµ¬ë¬¸ ì˜¤ë¥˜ - {e}')
                  errors.append(f'{py_file}: {e}')
          
          if errors:
              print(f'\\nâŒ ë¦¬íŒ©í† ë§ í›„ {len(errors)}ê°œ êµ¬ë¬¸ ì˜¤ë¥˜ ë°œê²¬!')
              for error in errors:
                  print(f'   - {error}')
              exit(1)
          else:
              print('âœ… ëª¨ë“  íŒŒì¼ êµ¬ë¬¸ ê²€ì‚¬ í†µê³¼')
          "
          
          # íˆ¬ì ì „ëµ í•¨ìˆ˜ ë¬´ê²°ì„± ê²€ì‚¬
          if [[ "${{ github.event.inputs.preserve_strategies }}" == "true" ]]; then
            echo "ğŸ›¡ï¸ íˆ¬ì ì „ëµ ë¬´ê²°ì„± ê²€ì‚¬..."
            python -c "
            import os
            import sys
            
            # í…ŒìŠ¤íŠ¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            os.environ['TESTING'] = 'true'
            os.environ['GEMINI_API_KEY'] = 'test_key'
            
            try:
                # í•µì‹¬ ì „ëµ ëª¨ë“ˆ ê²€ì¦
                from src.gemini_analyzer import GeminiAnalyzer
                print('âœ… GeminiAnalyzer ëª¨ë“ˆ ë¡œë“œ ì„±ê³µ')
                
                analyzer = GeminiAnalyzer()
                
                # ì „ëµ ë©”ì„œë“œ ì¡´ì¬ í™•ì¸
                strategy_methods = [
                    '_calculate_buffett_score',
                    '_calculate_lynch_score', 
                    '_calculate_graham_score',
                    '_apply_technical_analysis'
                ]
                
                for method_name in strategy_methods:
                    if hasattr(analyzer, method_name):
                        print(f'âœ… ì „ëµ ë©”ì„œë“œ ë³´ì¡´ë¨: {method_name}')
                    else:
                        print(f'âŒ ì „ëµ ë©”ì„œë“œ ëˆ„ë½: {method_name}')
                        sys.exit(1)
                
                print('ğŸ‰ ëª¨ë“  íˆ¬ì ì „ëµ ë¬´ê²°ì„± í™•ì¸ ì™„ë£Œ!')
                
            except Exception as e:
                print(f'âŒ ì „ëµ ë¬´ê²°ì„± ê²€ì‚¬ ì‹¤íŒ¨: {e}')
                sys.exit(1)
            "
          fi

      - name: ğŸ“Š ë¦¬íŒ©í† ë§ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          mkdir -p reports
          
          python -c "
          import os
          import subprocess
          from datetime import datetime
          
          # ë¦¬íŒ©í† ë§ ë¦¬í¬íŠ¸ ìƒì„±
          report = f'''# ğŸ”§ ìë™ ë¦¬íŒ©í† ë§ ë¦¬í¬íŠ¸
          
          **ì‹¤í–‰ ì‹œê°„**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
          **ë¦¬íŒ©í† ë§ ìˆ˜ì¤€**: ${{ github.event.inputs.refactor_level || 'safe' }}
          **ì „ëµ ë³´ì¡´**: ${{ github.event.inputs.preserve_strategies || 'true' }}
          
          ## ğŸ“ˆ ì½”ë“œ í’ˆì§ˆ ì§€í‘œ
          
          '''
          
          # Pylint ì ìˆ˜ ì¸¡ì •
          try:
              result = subprocess.run(['pylint', 'src/', '--score=y'], 
                                    capture_output=True, text=True)
              score_line = [line for line in result.stdout.split('\\n') if 'Your code has been rated' in line]
              if score_line:
                  report += f'### Pylint ì ìˆ˜\\n{score_line[0]}\\n\\n'
          except:
              report += '### Pylint ì ìˆ˜\\nì¸¡ì • ì‹¤íŒ¨\\n\\n'
          
          # íŒŒì¼ í†µê³„
          py_files = len(list(os.walk('src')))
          report += f'''### íŒŒì¼ í†µê³„
          - Python íŒŒì¼ ìˆ˜: {py_files}
          - ë³´í˜¸ëœ ì „ëµ ìš”ì†Œ: {len(open('protected_strategies.txt', 'r').readlines()) if os.path.exists('protected_strategies.txt') else 0}
          
          ## âœ… ë¦¬íŒ©í† ë§ ê²°ê³¼
          
          - ğŸ¨ ì½”ë“œ í¬ë§·íŒ…: ì™„ë£Œ
          - ğŸ“š Import ì •ë¦¬: ì™„ë£Œ  
          - ğŸ—‘ï¸ ë¶ˆí•„ìš”í•œ ì½”ë“œ ì œê±°: ì™„ë£Œ
          - ğŸ›¡ï¸ íˆ¬ì ì „ëµ ë³´ì¡´: {'âœ… í™•ì¸ë¨' if '${{ github.event.inputs.preserve_strategies }}' == 'true' else 'âš ï¸ ê±´ë„ˆëœ€'}
          
          ## ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„ ê¶Œì¥ì‚¬í•­
          
          1. ì½”ë“œ ë¦¬ë·° ì§„í–‰
          2. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          3. í†µí•© í…ŒìŠ¤íŠ¸ í™•ì¸
          4. ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸
          '''
          
          with open('${{ env.REFACTOR_REPORT_PATH }}', 'w', encoding='utf-8') as f:
              f.write(report)
          
          print('ğŸ“Š ë¦¬íŒ©í† ë§ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ')
          "

      - name: ğŸ’¾ ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "ğŸ”§ ìë™ ë¦¬íŒ©í† ë§ (${{ github.event.inputs.refactor_level || 'safe' }}) - $(date '+%Y-%m-%d %H:%M')"
            git push
            echo "âœ… ë¦¬íŒ©í† ë§ ê²°ê³¼ ì»¤ë°‹ ì™„ë£Œ"
          else
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ê±´ë„ˆëœ€"
          fi

      - name: ğŸ“± ì™„ë£Œ ì•Œë¦¼
        if: always()
        run: |
          python -c "
          import requests
          import os
          import json
          
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          
          if bot_token and chat_id:
              status = 'âœ… ì„±ê³µ' if '${{ job.status }}' == 'success' else 'âŒ ì‹¤íŒ¨'
              level = '${{ github.event.inputs.refactor_level || 'safe' }}'
              
              message = f'''ğŸ”§ ìë™ ë¦¬íŒ©í† ë§ ì™„ë£Œ
              
          **ìƒíƒœ**: {status}
          **ìˆ˜ì¤€**: {level}
          **íˆ¬ì ì „ëµ**: ğŸ›¡ï¸ ë³´ì¡´ë¨
          **ì‹œê°„**: $(date '+%Y-%m-%d %H:%M')
          
          ğŸ“Š ìƒì„¸ ë¦¬í¬íŠ¸ëŠ” GitHub Actionsì—ì„œ í™•ì¸í•˜ì„¸ìš”.'''
              
              try:
                  response = requests.post(
                      f'https://api.telegram.org/bot{bot_token}/sendMessage',
                      json={'chat_id': chat_id, 'text': message}
                  )
                  print('ğŸ“± í…”ë ˆê·¸ë¨ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ')
              except Exception as e:
                  print(f'âš ï¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: {e}')
          else:
              print('â„¹ï¸ í…”ë ˆê·¸ë¨ ì„¤ì • ì—†ìŒ - ì•Œë¦¼ ê±´ë„ˆëœ€')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: ğŸ“‹ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: refactor-report-${{ github.run_number }}
          path: |
            reports/refactor_analysis.md
            protected_strategies.txt
          retention-days: 30 