name: "ğŸš€ ê³ ê¸‰ ìŠ¤ìº˜í•‘ ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ"

on:
  schedule:
    - cron: '0 0 * * 1-5'    # ì›”-ê¸ˆ 09:00 (ì¥ì‹œì‘)
    - cron: '*/10 0-6 * * 1-5' # ì›”-ê¸ˆ 09:00-15:59, 10ë¶„ë§ˆë‹¤  
  workflow_dispatch:
  push:
    branches: [ main, develop ]

jobs:
  scalping_trading:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ”§ í™˜ê²½ ì„¤ì • í™•ì¸
        run: |
          echo "=== ì‹œìŠ¤í…œ í™˜ê²½ í™•ì¸ ==="
          python -c "
          import os
          
          # í…ŒìŠ¤íŠ¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          os.environ['IS_MOCK'] = 'True'
          os.environ['KIS_APP_KEY'] = 'test_key'
          os.environ['KIS_APP_SECRET'] = 'test_secret' 
          os.environ['KIS_ACCOUNT_NO'] = 'test_account'
          
          import config
          print(f'âœ… ëª¨ì˜íˆ¬ì ëª¨ë“œ: {config.IS_MOCK}')
          print(f'âœ… API í˜¸ì¶œ ì œí•œ: ì£¼ë¬¸({config.ORDER_API_CALLS_PER_SEC}/s), ì „ì²´({config.TOTAL_API_CALLS_PER_SEC}/s)')
          print(f'âœ… ì¼ì¼ API í•œë„: {config.DAILY_API_LIMIT}íšŒ')
          print('âœ… í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„ ì™„ë£Œ')
          "

      - name: ğŸš€ ê³ ê¸‰ ìŠ¤ìº˜í•‘ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
        run: |
          python -c "
          import os
          
          # í…ŒìŠ¤íŠ¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          os.environ['IS_MOCK'] = 'True'
          os.environ['KIS_APP_KEY'] = 'test_key'
          os.environ['KIS_APP_SECRET'] = 'test_secret'
          os.environ['KIS_ACCOUNT_NO'] = 'test_account'
          
          from core_trader import CoreTrader
          from advanced_scalping_system import AdvancedScalpingSystem
          import time
          
          print('ğŸŒ… ì¥ì‹œì‘ - ìŠ¤ìº˜í•‘ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ê°€ë™')
          
          try:
              trader = CoreTrader()
              print('âœ… CoreTrader ì´ˆê¸°í™” ì„±ê³µ')
              
              scalping = AdvancedScalpingSystem(trader)
              print('âœ… AdvancedScalpingSystem ì´ˆê¸°í™” ì„±ê³µ')
              
              # ì—°ê²° ìƒíƒœ í™•ì¸
              status = trader.get_connection_status()
              print(f'ğŸ“Š API ì—°ê²° ìƒíƒœ: {status}')
              
              # ì‹œì¥ ìŠ¤ìº” í…ŒìŠ¤íŠ¸ (ì‹¤ì œ API í˜¸ì¶œ ì—†ì´)
              print('ğŸ“Š ì‹œì¥ ìŠ¤ìº” í…ŒìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜...')
              scan_result = {'opportunities': [], 'scan_time': time.time()}
              print(f'   ë°œê²¬ëœ ê¸°íšŒ: {len(scan_result.get(\"opportunities\", []))}ê°œ')
              
              print('âœ… ìŠ¤ìº˜í•‘ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ')
              
          except Exception as e:
              print(f'âŒ ì˜¤ë¥˜ ë°œìƒ: {e}')
              print('âš ï¸ í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œ ì¼ë¶€ ê¸°ëŠ¥ ì œí•œë¨')
          "

      - name: ğŸ“± ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          python -c "
          import requests, os
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          if bot_token and chat_id:
              message = 'ğŸš€ ìŠ¤ìº˜í•‘ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!\\n\\nâœ… GitHub Actionsì—ì„œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
              try:
                  requests.post(f'https://api.telegram.org/bot{bot_token}/sendMessage', 
                              json={'chat_id': chat_id, 'text': message})
              except:
                  pass
          print('âœ… í…ŒìŠ¤íŠ¸ ì„¸ì…˜ ì™„ë£Œ')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: ğŸ“± ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          python -c "
          import requests, os
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          if bot_token and chat_id:
              message = 'âŒ ìŠ¤ìº˜í•‘ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!\\n\\nGitHub Actionsì—ì„œ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
              try:
                  requests.post(f'https://api.telegram.org/bot{bot_token}/sendMessage', 
                              json={'chat_id': chat_id, 'text': message})
              except:
                  pass
          print('âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }} 