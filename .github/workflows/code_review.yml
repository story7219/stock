name: "ğŸ” AI ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬"

on:
  workflow_dispatch:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST)ì— ì‹¤í–‰
    - cron: '0 0 * * *'

jobs:
  code_quality_check:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # ê³ ê¸‰ í’ˆì§ˆ ê²€ì‚¬ ë„êµ¬ë“¤ ì¶”ê°€
          pip install pylint flake8 black isort mypy bandit pytest pytest-cov

      - name: ğŸ¤– ê³ ê¸‰ AI ì½”ë“œ ë¦¬ë·° ì‹¤í–‰
        id: ai_review
        run: |
          echo "ğŸ¤– ê¸°ë³¸ AI ì½”ë“œ ë¦¬ë·°ì–´ ì‹¤í–‰ ì¤‘..."
          python .github/scripts/ai_reviewer.py > ai_review_output.txt 2>&1 || true
          
          if [ -f ai_review_output.txt ]; then
            echo "ğŸ“‹ ê¸°ë³¸ AI ë¦¬ë·° ê²°ê³¼:"
            cat ai_review_output.txt
          else
            echo "âš ï¸ ê¸°ë³¸ AI ë¦¬ë·° ê²°ê³¼ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ ê³ ê¸‰ AI ë¦¬ë·°ì–´ ì‹¤í–‰ (Gemini AI)
        id: advanced_ai_review
        run: |
          echo "ğŸš€ ê³ ê¸‰ AI ë¦¬ë·°ì–´ (Gemini AI) ì‹¤í–‰ ì¤‘..."
          python .github/scripts/advanced_ai_reviewer.py > advanced_ai_review_output.txt 2>&1 || true
          
          if [ -f advanced_ai_review_output.txt ]; then
            echo "ğŸ¯ ê³ ê¸‰ AI ë¦¬ë·° ê²°ê³¼:"
            cat advanced_ai_review_output.txt
          else
            echo "âš ï¸ ê³ ê¸‰ AI ë¦¬ë·° ê²°ê³¼ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” ì¢…í•© í’ˆì§ˆ ê²€ì‚¬ ì‹¤í–‰
        id: quality_check
        run: |
          echo "ğŸ” ì¢…í•© í’ˆì§ˆ ê²€ì‚¬ ì‹¤í–‰ ì¤‘..."
          python .github/scripts/quality_check.py > quality_check_output.txt 2>&1 || true
          
          if [ -f quality_check_output.txt ]; then
            echo "ğŸ“Š í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼:"
            cat quality_check_output.txt
            
            # ì ìˆ˜ ì¶”ì¶œ
            if grep -q "ì „ì²´ ì ìˆ˜:" quality_check_output.txt; then
              SCORE=$(grep "ì „ì²´ ì ìˆ˜:" quality_check_output.txt | grep -o '[0-9]\+\.[0-9]\+' | head -1)
              echo "QUALITY_SCORE=$SCORE" >> $GITHUB_ENV
            fi
          else
            echo "âš ï¸ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "QUALITY_SCORE=0.0" >> $GITHUB_ENV
          fi

      - name: ğŸ”§ ê¸°ë³¸ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (ê¸°ì¡´)
        run: |
          echo "=== íŒŒì´ì¬ êµ¬ë¬¸ ê²€ì‚¬ ==="
          python -c "
          import os
          import py_compile
          import glob
          
          # í•µì‹¬ íŒŒì¼ë“¤ë§Œ êµ¬ë¬¸ ê²€ì‚¬
          key_files = [
              'config.py',
              'core_trader.py', 
              'advanced_scalping_system.py',
              'test_optimized_scalping.py',
              'code_reviewer.py'
          ]
          
          errors = []
          for file in key_files:
              if os.path.exists(file):
                  try:
                      py_compile.compile(file, doraise=True)
                      print(f'âœ… {file}: êµ¬ë¬¸ ê²€ì‚¬ í†µê³¼')
                  except Exception as e:
                      print(f'âŒ {file}: êµ¬ë¬¸ ì˜¤ë¥˜ - {e}')
                      errors.append(f'{file}: {e}')
              else:
                  print(f'âš ï¸ {file}: íŒŒì¼ ì—†ìŒ')
          
          if errors:
              print(f'\\nâŒ ì´ {len(errors)}ê°œ íŒŒì¼ì— êµ¬ë¬¸ ì˜¤ë¥˜ ë°œê²¬')
              for error in errors:
                  print(f'   - {error}')
              exit(1)
          else:
              print('âœ… ëª¨ë“  í•µì‹¬ íŒŒì¼ êµ¬ë¬¸ ê²€ì‚¬ í†µê³¼')
          "

      - name: ğŸ” í•µì‹¬ ëª¨ë“ˆ ê²€ì‚¬ (ê¸°ì¡´)
        run: |
          echo "=== í•µì‹¬ ëª¨ë“ˆ ê²€ì‚¬ ==="
          python -c "
          import os
          import sys
          
          # í…ŒìŠ¤íŠ¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          os.environ['IS_MOCK'] = 'True'
          os.environ['KIS_APP_KEY'] = 'test_key'
          os.environ['KIS_APP_SECRET'] = 'test_secret'
          os.environ['KIS_ACCOUNT_NO'] = 'test_account'
          
          # í•µì‹¬ ëª¨ë“ˆë“¤ê³¼ í•„ìˆ˜ ì—¬ë¶€
          modules = [
              ('config', True),           # í•„ìˆ˜ ëª¨ë“ˆ
              ('core_trader', True),      # í•„ìˆ˜ ëª¨ë“ˆ  
              ('advanced_scalping_system', False)  # ì„ íƒì  ëª¨ë“ˆ
          ]
          
          critical_errors = []
          
          for module_name, is_required in modules:
              try:
                  __import__(module_name)
                  print(f'âœ… {module_name}: ì •ìƒ ë¡œë“œ')
              except Exception as e:
                  if is_required:
                      print(f'âŒ {module_name}: {e} (í•„ìˆ˜ ëª¨ë“ˆ)')
                      critical_errors.append(f'{module_name}: {e}')
                  else:
                      print(f'âš ï¸ {module_name}: {e} (ì„ íƒì  ëª¨ë“ˆ)')
          
          if critical_errors:
              print(f'\\nâŒ ì¹˜ëª…ì  ì˜¤ë¥˜ ë°œìƒ:')
              for error in critical_errors:
                  print(f'   - {error}')
              sys.exit(1)
          else:
              print('âœ… í•µì‹¬ ëª¨ë“ˆ ê²€ì‚¬ ì™„ë£Œ (ì„ íƒì  ëª¨ë“ˆ ì˜¤ë¥˜ëŠ” ë¬´ì‹œë¨)')
          "

      - name: ğŸ“Š í’ˆì§ˆ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: |
            quality_report.md
            ai_review_output.txt
            advanced_ai_review_output.txt
            quality_check_output.txt
          retention-days: 30

      - name: ğŸ’¬ PR ëŒ“ê¸€ ì‘ì„± (AI ë¦¬ë·° ê²°ê³¼)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let comment = '## ğŸ¤– AI ì½”ë“œ ë¦¬ë·° ê²°ê³¼\n\n';
            
            try {
              // ê¸°ë³¸ AI ë¦¬ë·° ê²°ê³¼
              if (fs.existsSync('ai_review_output.txt')) {
                const basicReview = fs.readFileSync('ai_review_output.txt', 'utf8');
                comment += '### ğŸ“‹ ê¸°ë³¸ AI ë¦¬ë·°\n\n```\n' + basicReview + '\n```\n\n';
              }
              
              // ê³ ê¸‰ AI ë¦¬ë·° ê²°ê³¼
              if (fs.existsSync('advanced_ai_review_output.txt')) {
                const advancedReview = fs.readFileSync('advanced_ai_review_output.txt', 'utf8');
                comment += '### ğŸš€ ê³ ê¸‰ AI ë¦¬ë·° (Gemini AI)\n\n```\n' + advancedReview + '\n```\n\n';
              }
              
              comment += '---\n*ğŸ”„ ì´ ë¦¬ë·°ëŠ” íˆ¬ì ë¶„ì„ ì‹œìŠ¤í…œ ì „ìš© AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤.*';
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('AI ë¦¬ë·° ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨:', error);
            }

      - name: ğŸ“± ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          python -c "
          import requests, os
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          score = os.environ.get('QUALITY_SCORE', '0.0')
          
          if bot_token and chat_id:
              message = 'ğŸ¤– AI ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ! (ê¸°ë³¸ + ê³ ê¸‰ AI ë¦¬ë·°) í’ˆì§ˆ ì ìˆ˜: ' + score + '/100 âœ… ëª¨ë“  ê²€ì‚¬ í†µê³¼'
              try:
                  requests.post(f'https://api.telegram.org/bot{bot_token}/sendMessage', 
                              json={'chat_id': chat_id, 'text': message})
              except:
                  pass
          print('âœ… ê¸°ë³¸ + ê³ ê¸‰ AI í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: ğŸ“± ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          python -c "
          import requests, os
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          score = os.environ.get('QUALITY_SCORE', '0.0')
          
          if bot_token and chat_id:
              message = 'ğŸš¨ AI ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨! (ê¸°ë³¸ + ê³ ê¸‰ AI ë¦¬ë·°) í’ˆì§ˆ ì ìˆ˜: ' + score + '/100 âŒ ì½”ë“œ ê²€í†  í•„ìš”'
              try:
                  requests.post(f'https://api.telegram.org/bot{bot_token}/sendMessage', 
                              json={'chat_id': chat_id, 'text': message})
              except:
                  pass
          print('âŒ ê¸°ë³¸ + ê³ ê¸‰ AI í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }} 