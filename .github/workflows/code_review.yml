name: "ğŸ” AI ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬"

on:
  schedule:
    - cron: '0 13 * * 0-4'  # ì¼-ëª© 22:00 (UTC ê¸°ì¤€ 13:00) - ì¥ ë§ˆê° í›„
  workflow_dispatch:
  push:
    branches: [ main, develop ]

jobs:
  code_quality_check:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ”§ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
        run: |
          echo "=== íŒŒì´ì¬ êµ¬ë¬¸ ê²€ì‚¬ ==="
          python -c "
          import os
          import py_compile
          import glob
          
          # í•µì‹¬ íŒŒì¼ë“¤ë§Œ êµ¬ë¬¸ ê²€ì‚¬
          key_files = [
              'config.py',
              'core_trader.py', 
              'advanced_scalping_system.py',
              'test_optimized_scalping.py',
              'code_reviewer.py'
          ]
          
          errors = []
          for file in key_files:
              if os.path.exists(file):
                  try:
                      py_compile.compile(file, doraise=True)
                      print(f'âœ… {file}: êµ¬ë¬¸ ê²€ì‚¬ í†µê³¼')
                  except Exception as e:
                      print(f'âŒ {file}: êµ¬ë¬¸ ì˜¤ë¥˜ - {e}')
                      errors.append(f'{file}: {e}')
              else:
                  print(f'âš ï¸ {file}: íŒŒì¼ ì—†ìŒ')
          
          if errors:
              print(f'\\nâŒ ì´ {len(errors)}ê°œ íŒŒì¼ì— êµ¬ë¬¸ ì˜¤ë¥˜ ë°œê²¬')
              for error in errors:
                  print(f'   - {error}')
              exit(1)
          else:
              print('âœ… ëª¨ë“  í•µì‹¬ íŒŒì¼ êµ¬ë¬¸ ê²€ì‚¬ í†µê³¼')
          "
          
          echo "=== í•µì‹¬ ëª¨ë“ˆ ê²€ì‚¬ ==="
          python -c "
          import os
          import sys
          
          # í…ŒìŠ¤íŠ¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          os.environ['IS_MOCK'] = 'True'
          os.environ['KIS_APP_KEY'] = 'test_key'
          os.environ['KIS_APP_SECRET'] = 'test_secret'
          os.environ['KIS_ACCOUNT_NO'] = 'test_account'
          
          modules = ['config', 'core_trader', 'advanced_scalping_system']
          for module in modules:
              try:
                  __import__(module)
                  print(f'âœ… {module}: ì •ìƒ')
              except Exception as e:
                  print(f'âŒ {module}: {e}')
                  # ì¹˜ëª…ì  ì˜¤ë¥˜ê°€ ì•„ë‹ˆë¼ë©´ ê³„ì† ì§„í–‰
                  if 'config' in module:
                      continue
                  sys.exit(1)
          print('âœ… í•µì‹¬ ëª¨ë“ˆ ê²€ì‚¬ ì™„ë£Œ')
          "

      - name: ğŸ” ìŠ¤ìº˜í•‘ ì‹œìŠ¤í…œ ë¬´ê²°ì„± ê²€ì‚¬
        run: |
          python -c "
          import os
          
          # í…ŒìŠ¤íŠ¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          os.environ['IS_MOCK'] = 'True'
          os.environ['KIS_APP_KEY'] = 'test_key'
          os.environ['KIS_APP_SECRET'] = 'test_secret'
          os.environ['KIS_ACCOUNT_NO'] = 'test_account'
          
          try:
              from core_trader import CoreTrader
              from advanced_scalping_system import AdvancedScalpingSystem
              
              print('ğŸ” ì‹œìŠ¤í…œ ë¬´ê²°ì„± ê²€ì‚¬ ì‹œì‘')
              
              # CoreTrader ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸
              trader = CoreTrader()
              print('âœ… CoreTrader ì´ˆê¸°í™” ì„±ê³µ')
              
              # ìŠ¤ìº˜í•‘ ì‹œìŠ¤í…œ ì´ˆê¸°í™” í…ŒìŠ¤íŠ¸
              scalping = AdvancedScalpingSystem(trader)
              print('âœ… AdvancedScalpingSystem ì´ˆê¸°í™” ì„±ê³µ')
              
              # ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
              try:
                  connection_status = trader.get_connection_status()
                  print(f'âœ… API ì—°ê²° ìƒíƒœ í™•ì¸: {type(connection_status)}')
              except Exception as e:
                  print(f'âš ï¸ API ì—°ê²° í…ŒìŠ¤íŠ¸ ì œí•œë¨: {e}')
              
              print('ğŸ‰ ì‹œìŠ¤í…œ ë¬´ê²°ì„± ê²€ì‚¬ ì™„ë£Œ!')
              
          except Exception as e:
              print(f'âŒ ì‹œìŠ¤í…œ ê²€ì‚¬ ì˜¤ë¥˜: {e}')
              print('âš ï¸ ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œëœ í™˜ê²½ì—ì„œ ì‹¤í–‰ë¨')
          "

      - name: ğŸ“Š ì½”ë“œ ë³µì¡ë„ ë¶„ì„
        run: |
          python -c "
          import os
          import ast
          
          def analyze_file(filepath):
              try:
                  with open(filepath, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  tree = ast.parse(content)
                  
                  classes = [n for n in ast.walk(tree) if isinstance(n, ast.ClassDef)]
                  functions = [n for n in ast.walk(tree) if isinstance(n, ast.FunctionDef)]
                  
                  return len(classes), len(functions), len(content.splitlines())
              except Exception as e:
                  return 0, 0, 0
          
          print('ğŸ“Š ì½”ë“œ ë³µì¡ë„ ë¶„ì„')
          print('=' * 50)
          
          key_files = [
              'core_trader.py',
              'advanced_scalping_system.py', 
              'config.py',
              'test_optimized_scalping.py'
          ]
          
          total_classes = 0
          total_functions = 0
          total_lines = 0
          
          for file in key_files:
              if os.path.exists(file):
                  classes, functions, lines = analyze_file(file)
                  print(f'{file:30} | í´ë˜ìŠ¤: {classes:2d} | í•¨ìˆ˜: {functions:3d} | ë¼ì¸: {lines:4d}')
                  total_classes += classes
                  total_functions += functions
                  total_lines += lines
              else:
                  print(f'{file:30} | âš ï¸  íŒŒì¼ ì—†ìŒ')
          
          print('=' * 50)
          print(f'ğŸ“ˆ ì „ì²´ í†µê³„: í´ë˜ìŠ¤ {total_classes}ê°œ, í•¨ìˆ˜ {total_functions}ê°œ, ì´ {total_lines}ë¼ì¸')
          print('âœ… ì½”ë“œ ë¶„ì„ ì™„ë£Œ')
          "

      - name: ğŸ“± ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          python -c "
          import requests, os
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          if bot_token and chat_id:
              message = 'âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ í†µê³¼!\\n\\nğŸ” ëª¨ë“  ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤.\\nì½”ë“œ ë¬´ê²°ì„±ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
              try:
                  requests.post(f'https://api.telegram.org/bot{bot_token}/sendMessage', 
                              json={'chat_id': chat_id, 'text': message})
              except:
                  pass
          print('âœ… í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: ğŸ“± ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        run: |
          python -c "
          import requests, os
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          if bot_token and chat_id:
              message = 'âŒ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨!\\n\\nğŸš¨ ì‹œìŠ¤í…œì— ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\\nì½”ë“œ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
              try:
                  requests.post(f'https://api.telegram.org/bot{bot_token}/sendMessage', 
                              json={'chat_id': chat_id, 'text': message})
              except:
                  pass
          print('âŒ í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }} 