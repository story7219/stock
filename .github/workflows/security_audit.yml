name: "ğŸ”’ ë³´ì•ˆ ê°ì‚¬ ë° ì·¨ì•½ì  ê²€ì‚¬"

on:
  schedule:
    - cron: '0 2 * * 1'      # ë§¤ì£¼ ì›”ìš”ì¼ 11:00 (ì£¼ê°„ ë³´ì•ˆ ì ê²€)
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '**/*.py'
      - '.env*'
      - 'requirements.txt'

jobs:
  security_audit:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ ë³´ì•ˆ ë„êµ¬ ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          pip install bandit safety semgrep
          pip install -r requirements.txt

      - name: ğŸ” API í‚¤ ë° ë¯¼ê°ì •ë³´ ê²€ì‚¬
        run: |
          echo "=== API í‚¤ ë° ë¯¼ê°ì •ë³´ ë…¸ì¶œ ê²€ì‚¬ ==="
          python -c "
          import os
          import re
          import glob
          
          # ë¯¼ê°ì •ë³´ íŒ¨í„´ë“¤
          sensitive_patterns = [
              (r'[A-Za-z0-9]{20,}', 'API í‚¤ í˜•íƒœ'),
              (r'sk-[a-zA-Z0-9]{20,}', 'OpenAI API í‚¤'),
              (r'xoxb-[0-9]{11,13}-[0-9]{11,13}-[a-zA-Z0-9]{24}', 'Slack Bot Token'),
              (r'AKIA[0-9A-Z]{16}', 'AWS Access Key'),
              (r'[0-9]{10}:[A-Za-z0-9_-]{35}', 'Telegram Bot Token'),
              (r'AIza[0-9A-Za-z\\-_]{35}', 'Google API Key'),
              (r'[a-zA-Z0-9]{32}', '32ì í† í°'),
              (r'Bearer [A-Za-z0-9\\-\\._~\\+\\/]+=*', 'Bearer Token')
          ]
          
          # ê²€ì‚¬í•  íŒŒì¼ í™•ì¥ì
          file_patterns = ['*.py', '*.yml', '*.yaml', '*.json', '*.md', '*.txt']
          
          findings = []
          excluded_files = ['.git', '__pycache__', '.venv', 'node_modules']
          
          for pattern in file_patterns:
              for filepath in glob.glob(f'**/{pattern}', recursive=True):
                  # ì œì™¸í•  ë””ë ‰í† ë¦¬ ê±´ë„ˆë›°ê¸°
                  if any(exc in filepath for exc in excluded_files):
                      continue
                  
                  try:
                      with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                          content = f.read()
                          
                      for regex, desc in sensitive_patterns:
                          matches = re.finditer(regex, content)
                          for match in matches:
                              # ì£¼ì„ì´ë‚˜ ì˜ˆì‹œëŠ” ì œì™¸
                              line = content[:match.start()].count('\\n') + 1
                              matched_text = match.group()
                              
                              # í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ (ì˜ˆì‹œë‚˜ í…ŒìŠ¤íŠ¸ ê°’ë“¤)
                              whitelist = [
                                  'test_key', 'test_secret', 'test_token', 'example',
                                  'YOUR_API_KEY', 'placeholder', 'dummy', 'sample'
                              ]
                              
                              if not any(white in matched_text.lower() for white in whitelist):
                                  if len(matched_text) > 10:  # ë„ˆë¬´ ì§§ì€ ë§¤ì¹˜ ì œì™¸
                                      findings.append(f'{filepath}:{line} - {desc}: {matched_text[:20]}...')
          
          if findings:
              print('âš ï¸ ì ì¬ì  ë¯¼ê°ì •ë³´ ë°œê²¬:')
              for finding in findings[:10]:  # ìµœëŒ€ 10ê°œë§Œ í‘œì‹œ
                  print(f'   {finding}')
              if len(findings) > 10:
                  print(f'   ... ì™¸ {len(findings)-10}ê°œ ë”')
          else:
              print('âœ… í•˜ë“œì½”ë”©ëœ ë¯¼ê°ì •ë³´ ì—†ìŒ')
          "

      - name: ğŸ›¡ï¸ Python ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ (Bandit)
        run: |
          echo "=== Python ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ==="
          bandit -r . -f json -o bandit_report.json || true
          python -c "
          import json
          import os
          
          if os.path.exists('bandit_report.json'):
              with open('bandit_report.json', 'r') as f:
                  report = json.load(f)
              
              high_issues = [issue for issue in report.get('results', []) if issue['issue_severity'] == 'HIGH']
              medium_issues = [issue for issue in report.get('results', []) if issue['issue_severity'] == 'MEDIUM']
              
              print(f'ğŸ”´ ê³ ìœ„í—˜ ì·¨ì•½ì : {len(high_issues)}ê°œ')
              print(f'ğŸŸ¡ ì¤‘ìœ„í—˜ ì·¨ì•½ì : {len(medium_issues)}ê°œ')
              
              if high_issues:
                  print('\\nâš ï¸ ê³ ìœ„í—˜ ì·¨ì•½ì  ìƒì„¸:')
                  for issue in high_issues[:5]:
                      print(f'   {issue[\"filename\"]}:{issue[\"line_number\"]} - {issue[\"test_name\"]}')
                      print(f'     {issue[\"issue_text\"]}')
              
              if len(high_issues) == 0 and len(medium_issues) <= 5:
                  print('âœ… ì‹¬ê°í•œ ë³´ì•ˆ ì·¨ì•½ì  ì—†ìŒ')
          else:
              print('âš ï¸ Bandit ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨')
          "

      - name: ğŸ“š ì˜ì¡´ì„± ì·¨ì•½ì  ê²€ì‚¬ (Safety)
        run: |
          echo "=== ì˜ì¡´ì„± ì·¨ì•½ì  ê²€ì‚¬ ==="
          safety check --json --output safety_report.json || true
          python -c "
          import json
          import os
          
          if os.path.exists('safety_report.json'):
              with open('safety_report.json', 'r') as f:
                  content = f.read()
                  if content.strip():
                      try:
                          report = json.loads(content)
                          vulnerabilities = report if isinstance(report, list) else []
                          
                          print(f'ğŸ“¦ ë°œê²¬ëœ ì·¨ì•½ì : {len(vulnerabilities)}ê°œ')
                          
                          if vulnerabilities:
                              print('\\nâš ï¸ ì·¨ì•½í•œ íŒ¨í‚¤ì§€:')
                              for vuln in vulnerabilities[:5]:
                                  if isinstance(vuln, dict):
                                      pkg = vuln.get('package', 'Unknown')
                                      version = vuln.get('installed_version', 'Unknown')
                                      advisory = vuln.get('advisory', 'No description')
                                      print(f'   {pkg} v{version}: {advisory[:100]}...')
                          else:
                              print('âœ… ì•Œë ¤ì§„ ì·¨ì•½ì  ì—†ìŒ')
                      except json.JSONDecodeError:
                          print('âœ… ì·¨ì•½ì  ì—†ìŒ (JSON íŒŒì‹± ì˜¤ë¥˜)')
                  else:
                      print('âœ… ì˜ì¡´ì„± ì·¨ì•½ì  ì—†ìŒ')
          else:
              print('âš ï¸ Safety ê²€ì‚¬ ê²°ê³¼ ì—†ìŒ')
          "

      - name: ğŸ”§ í™˜ê²½ ì„¤ì • ë³´ì•ˆ ê²€ì‚¬
        run: |
          python -c "
          import os
          
          print('ğŸ”§ í™˜ê²½ ì„¤ì • ë³´ì•ˆ ê²€ì‚¬')
          print('=' * 50)
          
          # GitHub Secrets ì‚¬ìš© ì—¬ë¶€ í™•ì¸
          expected_secrets = [
              'TELEGRAM_BOT_TOKEN',
              'TELEGRAM_CHAT_ID', 
              'MOCK_KIS_APP_KEY',
              'MOCK_KIS_APP_SECRET',
              'MOCK_KIS_ACCOUNT_NUMBER'
          ]
          
          print('ğŸ“‹ GitHub Secrets í™•ì¸:')
          missing_secrets = []
          for secret in expected_secrets:
              if os.environ.get(secret):
                  if os.environ.get(secret) in ['test_telegram_token', 'test_key', 'test_secret']:
                      print(f'   âš ï¸ {secret}: í…ŒìŠ¤íŠ¸ ê°’ ì‚¬ìš© ì¤‘')
                  else:
                      print(f'   âœ… {secret}: ì„¤ì •ë¨')
              else:
                  print(f'   âŒ {secret}: ëˆ„ë½')
                  missing_secrets.append(secret)
          
          # .env íŒŒì¼ ë³´ì•ˆ ê²€ì‚¬
          print(f'\\nğŸ“„ .env íŒŒì¼ ë³´ì•ˆ:')
          if os.path.exists('.env'):
              print('   âŒ .env íŒŒì¼ì´ ì €ì¥ì†Œì— ìˆìŠµë‹ˆë‹¤! ì¦‰ì‹œ ì œê±°í•˜ì„¸ìš”.')
          else:
              print('   âœ… .env íŒŒì¼ì´ ì €ì¥ì†Œì— ì—†ìŒ')
          
          # .gitignore í™•ì¸
          if os.path.exists('.gitignore'):
              with open('.gitignore', 'r') as f:
                  gitignore = f.read()
              
              required_ignores = ['.env', '*.log', '__pycache__', '.venv']
              missing_ignores = []
              for ignore in required_ignores:
                  if ignore not in gitignore:
                      missing_ignores.append(ignore)
              
              if missing_ignores:
                  print(f'   âš ï¸ .gitignoreì— ì¶”ê°€ ê¶Œì¥: {missing_ignores}')
              else:
                  print('   âœ… .gitignore ì„¤ì • ì–‘í˜¸')
          else:
              print('   âš ï¸ .gitignore íŒŒì¼ ì—†ìŒ')
          
          # ë³´ì•ˆ ë“±ê¸‰ ê³„ì‚°
          security_score = 100
          security_score -= len(missing_secrets) * 10
          if os.path.exists('.env'):
              security_score -= 30
          
          print(f'\\nğŸ¯ ë³´ì•ˆ ì ìˆ˜: {security_score}/100')
          if security_score >= 80:
              print('   ë“±ê¸‰: ìš°ìˆ˜ ğŸŸ¢')
          elif security_score >= 60:
              print('   ë“±ê¸‰: ì–‘í˜¸ ğŸŸ¡')
          else:
              print('   ë“±ê¸‰: ê°œì„  í•„ìš” ğŸ”´')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MOCK_KIS_APP_KEY: ${{ secrets.MOCK_KIS_APP_KEY }}
          MOCK_KIS_APP_SECRET: ${{ secrets.MOCK_KIS_APP_SECRET }}
          MOCK_KIS_ACCOUNT_NUMBER: ${{ secrets.MOCK_KIS_ACCOUNT_NUMBER }}

      - name: ğŸ“± ë³´ì•ˆ ë¦¬í¬íŠ¸ ì „ì†¡
        if: success()
        run: |
          python -c "
          import requests
          import os
          from datetime import datetime
          
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          
          if bot_token and chat_id and bot_token != 'test_telegram_token':
              message = f'''ğŸ”’ ë³´ì•ˆ ê°ì‚¬ ì™„ë£Œ!
              
              ğŸ“… ê²€ì‚¬ì¼: {datetime.now().strftime('%Y-%m-%d %H:%M')}
              
              âœ… API í‚¤ ë…¸ì¶œ ê²€ì‚¬ ì™„ë£Œ
              âœ… Python ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ì™„ë£Œ  
              âœ… ì˜ì¡´ì„± ì·¨ì•½ì  ê²€ì‚¬ ì™„ë£Œ
              âœ… í™˜ê²½ ì„¤ì • ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ
              
              ğŸ›¡ï¸ ì‹œìŠ¤í…œ ë³´ì•ˆì´ ì–‘í˜¸í•©ë‹ˆë‹¤.'''
              
              try:
                  requests.post(
                      f'https://api.telegram.org/bot{bot_token}/sendMessage',
                      json={'chat_id': chat_id, 'text': message}
                  )
                  print('âœ… ë³´ì•ˆ ë¦¬í¬íŠ¸ ì „ì†¡ ì™„ë£Œ')
              except Exception as e:
                  print(f'âš ï¸ í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨: {e}')
          else:
              print('âœ… ë³´ì•ˆ ê°ì‚¬ ì™„ë£Œ (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: ğŸ“± ë³´ì•ˆ ê²½ê³  ì•Œë¦¼
        if: failure()
        run: |
          python -c "
          import requests
          import os
          from datetime import datetime
          
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          
          if bot_token and chat_id and bot_token != 'test_telegram_token':
              message = f'''ğŸš¨ ë³´ì•ˆ ê°ì‚¬ ê²½ê³ !
              
              âš ï¸ ë³´ì•ˆ ê²€ì‚¬ ì¤‘ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.
              ğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M')}
              
              ì¦‰ì‹œ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.
              GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.'''
              
              try:
                  requests.post(
                      f'https://api.telegram.org/bot{bot_token}/sendMessage',
                      json={'chat_id': chat_id, 'text': message}
                  )
              except:
                  pass
          print('ğŸš¨ ë³´ì•ˆ ê²½ê³  ë°œìƒ')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }} 