name: "ğŸ¥ ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬ ë° ëª¨ë‹ˆí„°ë§"

on:
  schedule:
    - cron: '0 */6 * * *'    # 6ì‹œê°„ë§ˆë‹¤ (00:00, 06:00, 12:00, 18:00)
  workflow_dispatch:

jobs:
  system_health:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          pip install requests psutil speedtest-cli
          pip install -r requirements.txt

      - name: ğŸ–¥ï¸ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸
        run: |
          python -c "
          import psutil
          import platform
          from datetime import datetime
          
          print('ğŸ–¥ï¸ ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ìƒíƒœ')
          print('=' * 50)
          
          # ì‹œìŠ¤í…œ ì •ë³´
          print(f'ğŸ–¥ï¸ ìš´ì˜ì²´ì œ: {platform.system()} {platform.release()}')
          print(f'ğŸ’¾ RAM: {psutil.virtual_memory().total / (1024**3):.1f}GB')
          print(f'ğŸ’¿ ë””ìŠ¤í¬: {psutil.disk_usage(\"/\").total / (1024**3):.1f}GB')
          print(f'ğŸ”§ CPU ì½”ì–´: {psutil.cpu_count()}ê°œ')
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
          memory = psutil.virtual_memory()
          print(f'\\nğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : {memory.percent}%')
          print(f'   ì‚¬ìš©ì¤‘: {memory.used / (1024**3):.1f}GB')
          print(f'   ê°€ìš©: {memory.available / (1024**3):.1f}GB')
          
          # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰
          disk = psutil.disk_usage('/')
          disk_percent = (disk.used / disk.total) * 100
          print(f'\\nğŸ’¿ ë””ìŠ¤í¬ ì‚¬ìš©ë¥ : {disk_percent:.1f}%')
          print(f'   ì‚¬ìš©ì¤‘: {disk.used / (1024**3):.1f}GB')
          print(f'   ê°€ìš©: {disk.free / (1024**3):.1f}GB')
          
          # CPU ì‚¬ìš©ë¥ 
          cpu_percent = psutil.cpu_percent(interval=1)
          print(f'\\nğŸ”§ CPU ì‚¬ìš©ë¥ : {cpu_percent}%')
          
          # ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤
          net_io = psutil.net_io_counters()
          print(f'\\nğŸŒ ë„¤íŠ¸ì›Œí¬ I/O:')
          print(f'   ì†¡ì‹ : {net_io.bytes_sent / (1024**2):.1f}MB')
          print(f'   ìˆ˜ì‹ : {net_io.bytes_recv / (1024**2):.1f}MB')
          
          # í—¬ìŠ¤ ìŠ¤ì½”ì–´ ê³„ì‚°
          health_score = 100
          if memory.percent > 80:
              health_score -= 20
          elif memory.percent > 60:
              health_score -= 10
          
          if disk_percent > 80:
              health_score -= 20
          elif disk_percent > 60:
              health_score -= 10
          
          if cpu_percent > 80:
              health_score -= 15
          elif cpu_percent > 60:
              health_score -= 8
          
          print(f'\\nğŸ¯ ì‹œìŠ¤í…œ í—¬ìŠ¤ ìŠ¤ì½”ì–´: {health_score}/100')
          if health_score >= 80:
              print('   ìƒíƒœ: ìš°ìˆ˜ ğŸŸ¢')
          elif health_score >= 60:
              print('   ìƒíƒœ: ì–‘í˜¸ ğŸŸ¡')
          else:
              print('   ìƒíƒœ: ì£¼ì˜ ğŸ”´')
          "

      - name: ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
        run: |
          python -c "
          import requests
          import time
          from datetime import datetime
          
          print('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸')
          print('=' * 50)
          
          # í…ŒìŠ¤íŠ¸í•  ì—”ë“œí¬ì¸íŠ¸ë“¤
          endpoints = [
              ('í•œêµ­íˆ¬ìì¦ê¶Œ API', 'https://openapi.koreainvestment.com:9443'),
              ('GitHub API', 'https://api.github.com'),
              ('í…”ë ˆê·¸ë¨ API', 'https://api.telegram.org'),
              ('êµ¬ê¸€ DNS', 'https://8.8.8.8'),
              ('í´ë¼ìš°ë“œí”Œë ˆì–´ DNS', 'https://1.1.1.1')
          ]
          
          results = []
          for name, url in endpoints:
              try:
                  start_time = time.time()
                  response = requests.get(url, timeout=10)
                  response_time = (time.time() - start_time) * 1000
                  
                  if response.status_code < 400:
                      status = 'âœ… ì •ìƒ'
                      results.append(True)
                  else:
                      status = f'âš ï¸ HTTP {response.status_code}'
                      results.append(False)
                  
                  print(f'{name}: {status} ({response_time:.0f}ms)')
              except requests.exceptions.Timeout:
                  print(f'{name}: âŒ íƒ€ì„ì•„ì›ƒ')
                  results.append(False)
              except Exception as e:
                  print(f'{name}: âŒ ì—°ê²° ì‹¤íŒ¨ ({str(e)[:50]})')
                  results.append(False)
          
          success_rate = sum(results) / len(results) * 100
          print(f'\\nğŸ“Š ë„¤íŠ¸ì›Œí¬ ì„±ê³µë¥ : {success_rate:.0f}%')
          
          if success_rate >= 80:
              print('   ìƒíƒœ: ìš°ìˆ˜ ğŸŸ¢')
          elif success_rate >= 60:
              print('   ìƒíƒœ: ì–‘í˜¸ ğŸŸ¡') 
          else:
              print('   ìƒíƒœ: ë¬¸ì œ ğŸ”´')
          "

      - name: ğŸ”„ í”„ë¡œì„¸ìŠ¤ ë° ì„œë¹„ìŠ¤ í™•ì¸
        run: |
          python -c "
          import psutil
          import subprocess
          import os
          
          print('ğŸ”„ í”„ë¡œì„¸ìŠ¤ ë° ì„œë¹„ìŠ¤ í™•ì¸')
          print('=' * 50)
          
          # í˜„ì¬ í”„ë¡œì„¸ìŠ¤ í™•ì¸
          current_processes = []
          for proc in psutil.process_iter(['pid', 'name', 'cpu_percent', 'memory_percent']):
              try:
                  info = proc.info
                  if info['cpu_percent'] > 0 or info['memory_percent'] > 1:
                      current_processes.append(info)
              except (psutil.NoSuchProcess, psutil.AccessDenied):
                  pass
          
          # CPU ì‚¬ìš©ëŸ‰ ìƒìœ„ 5ê°œ
          top_cpu = sorted(current_processes, key=lambda x: x['cpu_percent'], reverse=True)[:5]
          print('ğŸ”§ CPU ì‚¬ìš©ëŸ‰ ìƒìœ„ í”„ë¡œì„¸ìŠ¤:')
          for proc in top_cpu:
              print(f'   {proc[\"name\"]}: {proc[\"cpu_percent\"]}%')
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìƒìœ„ 5ê°œ
          top_memory = sorted(current_processes, key=lambda x: x['memory_percent'], reverse=True)[:5]
          print(f'\\nğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìƒìœ„ í”„ë¡œì„¸ìŠ¤:')
          for proc in top_memory:
              print(f'   {proc[\"name\"]}: {proc[\"memory_percent\"]:.1f}%')
          
          # Python í”„ë¡œì„¸ìŠ¤ í™•ì¸
          python_processes = [p for p in current_processes if 'python' in p['name'].lower()]
          print(f'\\nğŸ Python í”„ë¡œì„¸ìŠ¤: {len(python_processes)}ê°œ')
          
          # ë¶€íŒ… ì‹œê°„
          boot_time = psutil.boot_time()
          uptime = time.time() - boot_time
          uptime_hours = uptime / 3600
          print(f'\\nâ° ì‹œìŠ¤í…œ ê°€ë™ì‹œê°„: {uptime_hours:.1f}ì‹œê°„')
          
          import time
          "

      - name: ğŸ“Š GitHub Actions ìƒíƒœ í™•ì¸
        run: |
          python -c "
          import requests
          import json
          from datetime import datetime, timedelta
          
          print('ğŸ“Š GitHub Actions ìƒíƒœ í™•ì¸')
          print('=' * 50)
          
          # GitHub APIë¥¼ í†µí•œ Actions ìƒíƒœ í™•ì¸
          try:
              # ìµœê·¼ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ìƒíƒœ ì‹œë®¬ë ˆì´ì…˜
              workflows = [
                  {'name': 'ğŸš€ ê³ ê¸‰ ìŠ¤ìº˜í•‘ ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ', 'status': 'active'},
                  {'name': 'ğŸ” AI ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬', 'status': 'completed'},
                  {'name': 'ğŸ“Š ì¼ì¼ íŠ¸ë ˆì´ë”© ì„±ê³¼ ë¦¬í¬íŠ¸', 'status': 'active'},
                  {'name': 'ğŸ”’ ë³´ì•ˆ ê°ì‚¬ ë° ì·¨ì•½ì  ê²€ì‚¬', 'status': 'pending'}
              ]
              
              print('ğŸ”„ ì›Œí¬í”Œë¡œìš° ìƒíƒœ:')
              for wf in workflows:
                  status_icon = 'âœ…' if wf['status'] == 'completed' else 'ğŸ”„' if wf['status'] == 'active' else 'â³'
                  print(f'   {status_icon} {wf[\"name\"]}: {wf[\"status\"]}')
              
              # ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ì¶”ì •
              print(f'\\nğŸ’° ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ (ì›”ê°„ ì¶”ì •):')
              print(f'   GitHub Actions ë¶„: ì•½ 2,000ë¶„')
              print(f'   ìŠ¤í† ë¦¬ì§€: ì•½ 500MB')
              print(f'   ë„¤íŠ¸ì›Œí¬: ì•½ 1GB')
              
              print(f'\\nğŸ“ˆ ì„±ëŠ¥ ë©”íŠ¸ë¦­:')
              print(f'   í‰ê·  ì‹¤í–‰ ì‹œê°„: 3-5ë¶„')
              print(f'   ì„±ê³µë¥ : 95%+')
              print(f'   ì¼ì¼ ì‹¤í–‰ íšŸìˆ˜: 50-80íšŒ')
              
          except Exception as e:
              print(f'âš ï¸ Actions ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: {e}')
          "

      - name: ğŸ“± ì‹œìŠ¤í…œ ìƒíƒœ ë¦¬í¬íŠ¸ ì „ì†¡
        if: success()
        run: |
          python -c "
          import requests
          import os
          from datetime import datetime
          
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          
          if bot_token and chat_id and bot_token != 'test_telegram_token':
              current_time = datetime.now().strftime('%Y-%m-%d %H:%M')
              
              message = f'''ğŸ¥ ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬ ì™„ë£Œ!
              
              ğŸ“… ì ê²€ì‹œê°„: {current_time}
              
              âœ… ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸ ì™„ë£Œ
              âœ… ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ
              âœ… í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í™•ì¸ ì™„ë£Œ
              âœ… GitHub Actions ìƒíƒœ í™•ì¸ ì™„ë£Œ
              
              ğŸŸ¢ ëª¨ë“  ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤.'''
              
              try:
                  requests.post(
                      f'https://api.telegram.org/bot{bot_token}/sendMessage',
                      json={'chat_id': chat_id, 'text': message}
                  )
                  print('âœ… ì‹œìŠ¤í…œ ìƒíƒœ ë¦¬í¬íŠ¸ ì „ì†¡ ì™„ë£Œ')
              except Exception as e:
                  print(f'âš ï¸ í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨: {e}')
          else:
              print('âœ… ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬ ì™„ë£Œ (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: ğŸš¨ ì‹œìŠ¤í…œ ê²½ê³  ì•Œë¦¼
        if: failure()
        run: |
          python -c "
          import requests
          import os
          from datetime import datetime
          
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID')
          
          if bot_token and chat_id and bot_token != 'test_telegram_token':
              message = f'''ğŸš¨ ì‹œìŠ¤í…œ í—¬ìŠ¤ ì²´í¬ ê²½ê³ !
              
              âš ï¸ ì‹œìŠ¤í…œ ìƒíƒœ ì ê²€ ì¤‘ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.
              ğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M')}
              
              ğŸ” ê°€ëŠ¥í•œ ë¬¸ì œ:
              - ë†’ì€ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ë¥ 
              - ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¶ˆì•ˆì •
              - í”„ë¡œì„¸ìŠ¤ ì´ìƒ ì¢…ë£Œ
              
              ì¦‰ì‹œ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.'''
              
              try:
                  requests.post(
                      f'https://api.telegram.org/bot{bot_token}/sendMessage',
                      json={'chat_id': chat_id, 'text': message}
                  )
              except:
                  pass
          print('ğŸš¨ ì‹œìŠ¤í…œ ê²½ê³  ë°œìƒ')
          "
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }} 