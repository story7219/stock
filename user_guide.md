# 🤖 AI 기반 자동매매 시스템 (v3.0 - API 중심 아키텍처)

**안정적인 공식 API와 Gemini AI를 결합한 차세대 자동매매 시스템**

## 📋 목차

1. [시스템 개요](#-시스템-개요)
2. [핵심 아키텍처](#-핵심-아키텍처)
3. [주요 기능](#-주요-기능)
4. [설치 및 설정](#-설치-및-설정)
5. [실행 방법](#-실행-방법)
6. [안전장치](#-안전장치)
7. [모니터링](#-모니터링)
8. [문제 해결](#-문제-해결)

---

## 🎯 시스템 개요

이 프로젝트는 불안정한 웹 스크레이핑이나 비공식 라이브러리에 대한 의존성을 최소화하고, **증권사(한국투자증권)와 DART(전자공시시스템)의 공식 API**를 중심으로 데이터를 수집하고 거래를 실행하는 안정적인 AI 기반 자동매매 시스템입니다.

Gemini 1.5 Pro/Flash AI 모델을 활용하여 수집된 데이터를 심층 분석하고, 시장 상황에 맞는 최적의 투자 판단을 내립니다. 시스템의 모든 판단 과정은 터미널에 상세히 출력되어 높은 투명성을 제공합니다.

---

## 🏛️ 핵심 아키텍처

본 시스템은 역할이 명확하게 분리된 4개의 핵심 모듈로 구성되어 유기적으로 작동합니다.

1.  **`CoreTrader` (핵심 거래 엔진)**
    *   **역할**: 모든 거래 실행 및 계좌 관리의 유일한 창구.
    *   **주요 기능**: 한국투자증권(KIS) API를 통한 매수/매도 주문, 잔고 조회, 실시간 시세 조회 등 모든 통신을 담당합니다. 비동기(asyncio) 및 API 호출 제한(Rate Limiting)을 통해 안정적인 통신을 보장합니다.

2.  **`MarketDataProvider` (데이터 공급자)**
    *   **역할**: AI 분석에 필요한 모든 데이터를 수집하고 가공합니다.
    *   **주요 기능**:
        *   **KIS API**: 주도 테마/업종 순위, 시장 지수, 종목별 가격 데이터 등 실시간 데이터를 수집합니다.
        *   **DART API**: 재무제표, 주요 공시, 기업 개요 등 신뢰도 높은 정적 데이터를 수집합니다.
        *   **뉴스 API/Scraping**: 네이버 금융 등에서 최신 뉴스를 수집하여 감성 분석의 재료로 사용합니다.

3.  **`AIAnalyzer` (AI 분석 엔진)**
    *   **역할**: 수집된 모든 데이터를 바탕으로 최종 투자 판단을 내리는 AI 두뇌.
    *   **주요 기능**:
        *   **Gemini 1.5 Pro**: `MarketDataProvider`가 수집한 모든 데이터(재무, 뉴스, 공시, 수급, 기술적 지표)를 종합하여 특정 종목에 대한 심층 분석 리포트를 생성합니다.
        *   **상세 리포트 출력**: AI의 분석 결과(매수/매도/보유 신호, 신뢰도, 분석 근거, 목표가, 손절가 등)를 터미널에 상세 JSON 형식으로 출력하여 모든 판단 과정을 투명하게 공개합니다.

4.  **`ScoutStrategyManager` (전략 관리자)**
    *   **역할**: 전체 투자 프로세스를 지휘하는 오케스트레이터.
    *   **주요 기능**:
        *   `MarketDataProvider`를 통해 시장 주도 테마와 유망 종목 후보군을 발굴합니다.
        *   발굴된 후보 종목을 `AIAnalyzer`에 전달하여 심층 분석을 요청합니다.
        *   AI의 최종 투자 결정을 받아 `CoreTrader`에 매매 주문을 전달할지 결정합니다.

---

## 🚀 주요 기능

- **API 중심 데이터 수집**: KIS, DART 등 신뢰도 높은 공식 API를 사용하여 데이터의 정확성과 안정성을 극대화합니다.
- **AI 기반 심층 분석**: Gemini 1.5 Pro/Flash 모델이 재무, 뉴스, 공시, 수급, 기술적 지표 등 다차원 데이터를 종합적으로 분석하여 투자 결정을 내립니다.
- **동적 테마 분석**: 시장의 주도 테마와 주도주를 실시간으로 포착하여 시장의 흐름에 동적으로 대응합니다.
- **투명한 의사결정 과정**: AI의 모든 분석 과정과 최종 판단 근거를 터미널에 상세 리포트 형식으로 출력하여 사용자가 시스템의 결정을 완벽하게 이해할 수 있도록 돕습니다.
- **안전한 비동기 처리**: `asyncio`와 `httpx`를 기반으로 시스템 전체를 비동기 처리하여 I/O 병목을 최소화하고 안정적인 성능을 보장합니다.

---

## 🔧 설치 및 설정

### 1. 환경 구성

```bash
# 1. 리포지토리 클론 및 이동
git clone [repository_url]
cd [repository_name]

# 2. 가상환경 생성 및 활성화
python -m venv .venv
# Windows
.venv\Scripts\activate
# Linux/macOS
# source .venv/bin/activate

# 3. 필수 라이브러리 설치
pip install -r requirements.txt
```

### 2. 환경 변수 설정 (`.env` 파일)

프로젝트 루트 디렉터리에 `.env` 파일을 생성하고 아래 내용을 채워주세요.

```env
# Gemini AI API 키
GEMINI_API_KEY="여기에 Gemini API 키를 입력하세요"

# 한국투자증권(KIS) API 키 (모의투자용 또는 실전투자용)
KIS_APP_KEY="여기에 KIS Application Key를 입력하세요"
KIS_APP_SECRET="여기에 KIS Application Secret을 입력하세요"
KIS_ACCOUNT_NO="계좌번호-상품코드 (예: 12345678-01)"
IS_MOCK=True # 모의투자 사용 시 True, 실전투자 시 False

# DART API 키 (전자공시시스템)
DART_API_KEY="여기에 DART 인증키를 입력하세요"

# 텔레그램 알림 설정 (선택사항)
TELEGRAM_BOT_TOKEN="여기에 텔레그램 봇 토큰을 입력하세요"
TELEGRAM_CHAT_ID="여기에 텔레그램 챗 ID를 입력하세요"

# 구글 시트 로깅 설정 (선택사항)
GOOGLE_SERVICE_ACCOUNT_FILE="path/to/your/service_account.json"
GOOGLE_SPREADSHEET_ID="매매일지를 기록할 구글 시트의 ID"
```
**API 키 발급처:**
*   **Gemini**: [Google AI for Developers](https://aistudio.google.com/app/apikey)
*   **KIS API**: [한국투자증권 개발자 센터](https://develop.koreainvestment.com/)
*   **DART API**: [DART 개발자 센터](https://opendart.fss.or.kr/)
*   **Telegram**: `BotFather`와 대화하여 발급

---

## 🚀 실행 방법

시스템을 실행하려면 터미널에 다음 명령어를 입력하세요. 현재 시스템은 가장 종합적인 분석을 수행하는 `advanced` 모드를 기본으로 테스트합니다.

```bash
python main.py advanced
```

### AI 분석 리포트 예시

`advanced` 모드 실행 시, AI가 특정 종목에 대한 분석을 완료하면 터미널에 다음과 같은 형식의 상세 리포트가 출력됩니다.

```json
 {
     "sentiment_analysis": {
         "sentiment": "긍정적",
         "reason": "최근 발표된 2분기 실적이 시장 컨센서스를 상회했으며, 주력 제품에 대한 긍정적인 뉴스 보도가 이어지고 있음."
     },
     "key_factors": {
         "bull_case": [
             "연기금을 중심으로 한 기관의 꾸준한 순매수 유입 확인",
             "DART 공시를 통해 확인된 신규 대규모 공급 계약"
         ],
         "bear_case": [
             "단기 급등에 따른 차익 실현 매물 출회 가능성",
             "환율 변동성에 따른 원가 부담 리스크"
         ]
     },
     "executive_summary": "우호적인 수급과 실적 개선 모멘텀을 바탕으로 추가 상승 가능성이 높다고 판단되나, 단기 조정 가능성에 유의할 필요가 있음.",
     "investment_score": 85,
     "actionable_advice": {
         "optimal_entry_timing": "눌림목 매수",
         "recommended_allocation_pct": 7.5,
         "primary_stop_loss_krw": 48500
     }
 }
```

이 리포트를 통해 AI의 판단 근거를 투명하게 확인하고, 시스템의 다음 행동을 예측할 수 있습니다.

---

## 🛡️ 안전장치

### 1. 재정적 안전장치 (config.py에서 설정 가능)

| 항목 | 기본값 | 설명 |
|------|--------|------|
| 일일 손실 한도 | 설정 필요 | 일일 누적 손실 제한 |
| 일일 거래 한도 | 설정 필요 | 일일 최대 거래 횟수 |
| 연속 손실 한도 | 설정 필요 | 연속 손실 시 자동 중지 |
| 단일 종목 한도 | 설정 필요 | 계좌 대비 단일 종목 비중 |

### 2. 기술적 안전장치

- **API 호출 제한 관리**: `CoreTrader`에 내장된 Rate Limiter가 증권사 API의 초당 호출 수를 자동으로 제어하여 시스템 안정성을 확보합니다.
- **재시도 메커니즘**: API 통신 실패 시, 설정된 횟수만큼 자동으로 재시도하여 일시적인 네트워크 오류에 대응합니다.
- **안전한 실패 처리**: 특정 모듈(예: 구글 시트 로거)에 문제가 발생해도, 핵심 트레이딩 로직은 중단되지 않고 계속 작동합니다.

### 3. 긴급 정지 조건

시스템이 자동으로 거래를 중단하는 주요 상황:

- 📉 설정된 재정적 안전장치 한도 도달
- 🌐 API 키 인증 실패 또는 지속적인 통신 장애 발생
- 🛠️ 시스템 초기화 과정에서 심각한 오류 발생

---

## 📱 모니터링

### 텔레그램 실시간 알림

(텔레그램 봇 토큰 및 챗 ID 설정 시)

```
🚀 자동매매 시스템이 시작되었습니다.

💰 매수 완료
📈 종목: 삼성전자 (005930)
💵 수량: 10주
💲 가격: 80,000원
🤖 사유: AI 분석 결과, 반도체 업황 개선 및 기관 수급 유입 확인. 투자점수 85점.

🚨 [주문 실패] 🚨
종목: SK하이닉스 (000660)
수량: 5주
사유: API 오류 - 잔고 부족

👋 자동매매 시스템이 안전하게 종료되었습니다.
```

### 일일 보고서 (구현 예정)

- 하루 동안의 매매 내역, 손익, AI 판단 성공률 등을 요약하여 리포트를 생성하고 텔레그램으로 전송하는 기능이 추가될 예정입니다.

---

## 🔍 문제 해결

### 자주 발생하는 문제

#### 1. ModuleNotFoundError
- **오류**: `ModuleNotFoundError: No module named 'some_library'`
- **해결**: `pip install -r requirements.txt` 명령어를 실행하여 모든 필수 라이브러리가 설치되었는지 확인하세요.

#### 2. API 인증/연결 실패
- **증상**: "API 키가 유효하지 않습니다", "토큰 발급 실패" 등의 로그가 표시됩니다.
- **해결**:
    1. `.env` 파일에 `KIS_APP_KEY`, `KIS_APP_SECRET`, `GEMINI_API_KEY`, `DART_API_KEY` 등이 정확히 입력되었는지 확인하세요.
    2. 한국투자증권 API 설정에서 해당 API 키가 활성화되어 있는지, IP 등록이 필요하다면 올바르게 등록되었는지 확인하세요.
    3. 방화벽이나 네트워크 환경이 API 서버와의 통신을 막고 있지 않은지 확인하세요.

#### 3. AI 분석 실패
- **증상**: "Gemini 분석 오류" 로그가 표시됩니다.
- **해결**:
    1. `GEMINI_API_KEY`가 올바른지 확인하세요.
    2. 구글 AI Studio에서 해당 API 키의 할당량이 초과되지 않았는지 확인하세요.

### 로그 파일 위치

- 시스템의 모든 활동은 `logs` 디렉터리 내에 날짜별로 기록됩니다.
- 문제가 발생했을 경우, 해당 날짜의 로그 파일을 확인하면 원인을 파악하는 데 큰 도움이 됩니다.

---

**⚠️ 투자 경고**: 이 프로젝트는 교육 및 연구 목적으로 제작되었습니다. 모든 투자의 책임은 투자자 본인에게 있으며, 이 시스템의 자동매매 기능으로 인해 발생하는 어떠한 손실에 대해서도 프로젝트 개발자는 책임을 지지 않습니다. 실제 투자에 사용하기 전 반드시 충분한 모의투자를 통해 시스템의 동작을 검증하시기 바랍니다.

**🚀 Happy Trading!** 🤖💰 