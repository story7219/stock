name: ğŸ§ª ì „ëµ ë°±í…ŒìŠ¤íŠ¸ & í…ŒìŠ¤íŠ¸

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'strategies/**'
      - 'trader.py'
      - 'tests/**'
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  unit-tests:
    name: ğŸ”¬ ìœ ë‹› í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock pytest-asyncio
    
    - name: ğŸ§ª ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=html
    
    - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: true

  strategy-backtest:
    name: ğŸ“ˆ ì „ëµ ë°±í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: unit-tests
    outputs:
      backtest-results: ${{ steps.backtest.outputs.results }}
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install backtrader quantlib-python
    
    - name: ğŸ“ˆ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      id: backtest
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python tests/run_backtest.py > backtest_results.json
        echo "results=$(cat backtest_results.json)" >> $GITHUB_OUTPUT
    
    - name: ğŸ“Š ë°±í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±
      run: |
        python tests/generate_backtest_report.py
    
    - name: ğŸ“‹ ê²°ê³¼ íŒŒì¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: backtest-results
        path: |
          backtest_results.json
          backtest_report.html
          backtest_charts/

  performance-analysis:
    name: ğŸ“Š ì„±ëŠ¥ ë¶„ì„
    runs-on: ubuntu-latest
    needs: strategy-backtest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ë¶„ì„ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install pyfolio empyrical
    
    - name: ğŸ“Š ì„±ëŠ¥ ì§€í‘œ ê³„ì‚°
      run: |
        python tests/performance_analyzer.py
    
    - name: ğŸ¯ ë²¤ì¹˜ë§ˆí¬ ë¹„êµ
      run: |
        python tests/benchmark_comparison.py

  report-results:
    name: ğŸ“ ê²°ê³¼ ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest
    needs: [unit-tests, strategy-backtest, performance-analysis]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v3
      with:
        name: backtest-results
    
    - name: ğŸ“ PR ì½”ë©˜íŠ¸ ì‘ì„±
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì½ê¸°
          let backtestResults = {};
          try {
            const resultsData = fs.readFileSync('backtest_results.json', 'utf8');
            backtestResults = JSON.parse(resultsData);
          } catch (e) {
            console.error('ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì½ê¸° ì‹¤íŒ¨:', e);
            backtestResults = { error: 'ê²°ê³¼ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
          }
          
          // ì„±ëŠ¥ ê¸°ì¤€ ì²´í¬
          const performanceCheck = {
            totalReturn: backtestResults.total_return || 0,
            maxDrawdown: backtestResults.max_drawdown || 0,
            winRate: backtestResults.win_rate || 0,
            sharpeRatio: backtestResults.sharpe_ratio || 0,
            passed: true,
            issues: []
          };
          
          // ì„±ëŠ¥ ê¸°ì¤€ ê²€ì¦
          if (performanceCheck.totalReturn < 0.05) {
            performanceCheck.passed = false;
            performanceCheck.issues.push('ì´ ìˆ˜ìµë¥ ì´ 5% ë¯¸ë§Œì…ë‹ˆë‹¤.');
          }
          
          if (performanceCheck.maxDrawdown > 0.15) {
            performanceCheck.passed = false;
            performanceCheck.issues.push('ìµœëŒ€ ì†ì‹¤ì´ 15%ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.');
          }
          
          if (performanceCheck.winRate < 0.4) {
            performanceCheck.passed = false;
            performanceCheck.issues.push('ìŠ¹ë¥ ì´ 40% ë¯¸ë§Œì…ë‹ˆë‹¤.');
          }
          
          if (performanceCheck.sharpeRatio < 1.0) {
            performanceCheck.passed = false;
            performanceCheck.issues.push('ìƒ¤í”„ ë¹„ìœ¨ì´ 1.0 ë¯¸ë§Œì…ë‹ˆë‹¤.');
          }
          
          // ë¦¬í¬íŠ¸ ìƒì„±
          const statusIcon = performanceCheck.passed ? 'âœ…' : 'âŒ';
          const statusText = performanceCheck.passed ? 'í†µê³¼' : 'ì‹¤íŒ¨';
          
          const comment = `
          # ğŸ§ª ìë™ ë°±í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ${statusIcon}
          
          ## ğŸ“Š ì£¼ìš” ì„±ê³¼ ì§€í‘œ
          
          | ì§€í‘œ | ê°’ | ê¸°ì¤€ | ìƒíƒœ |
          |------|----|----|------|
          | ì´ ìˆ˜ìµë¥  | ${(performanceCheck.totalReturn * 100).toFixed(2)}% | â‰¥ 5% | ${performanceCheck.totalReturn >= 0.05 ? 'âœ…' : 'âŒ'} |
          | ìµœëŒ€ ì†ì‹¤ | ${(performanceCheck.maxDrawdown * 100).toFixed(2)}% | â‰¤ 15% | ${performanceCheck.maxDrawdown <= 0.15 ? 'âœ…' : 'âŒ'} |
          | ìŠ¹ë¥  | ${(performanceCheck.winRate * 100).toFixed(2)}% | â‰¥ 40% | ${performanceCheck.winRate >= 0.4 ? 'âœ…' : 'âŒ'} |
          | ìƒ¤í”„ ë¹„ìœ¨ | ${performanceCheck.sharpeRatio.toFixed(2)} | â‰¥ 1.0 | ${performanceCheck.sharpeRatio >= 1.0 ? 'âœ…' : 'âŒ'} |
          
          ## ğŸ“ˆ ìƒì„¸ ê²°ê³¼
          
          - **ë°±í…ŒìŠ¤íŠ¸ ê¸°ê°„**: ${backtestResults.start_date || 'N/A'} ~ ${backtestResults.end_date || 'N/A'}
          - **ì´ ê±°ë˜ ìˆ˜**: ${backtestResults.total_trades || 0}íšŒ
          - **í‰ê·  ìˆ˜ìµë¥ **: ${((backtestResults.avg_return || 0) * 100).toFixed(2)}%
          - **ë³€ë™ì„±**: ${((backtestResults.volatility || 0) * 100).toFixed(2)}%
          - **ìµœëŒ€ ì—°ì† ì†ì‹¤**: ${backtestResults.max_consecutive_losses || 0}íšŒ
          
          ## ğŸ¯ ì „ëµë³„ ì„±ê³¼
          
          ${backtestResults.strategy_performance ? 
            Object.entries(backtestResults.strategy_performance)
              .map(([strategy, perf]) => `- **${strategy}**: ìˆ˜ìµë¥  ${(perf.return * 100).toFixed(2)}%, ê±°ë˜ ${perf.trades}íšŒ`)
              .join('\n') 
            : 'ì „ëµë³„ ì„±ê³¼ ë°ì´í„° ì—†ìŒ'}
          
          ${!performanceCheck.passed ? `
          ## âš ï¸ ì„±ëŠ¥ ì´ìŠˆ
          
          ${performanceCheck.issues.map(issue => `- ${issue}`).join('\n')}
          
          **ì´ PRì€ ì„±ëŠ¥ ê¸°ì¤€ì„ ë§Œì¡±í•˜ì§€ ì•Šì•„ ë³‘í•©ì´ ì œí•œë©ë‹ˆë‹¤.**
          ` : ''}
          
          ## ğŸ“‹ í…ŒìŠ¤íŠ¸ ìƒíƒœ: **${statusText}**
          
          ---
          *ì´ ë¦¬í¬íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒì„¸í•œ ì°¨íŠ¸ì™€ ë¶„ì„ì€ Actions ì•„í‹°íŒ©íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.*
          `;
          
          // PR ì½”ë©˜íŠ¸ ì‘ì„±
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
          // ì„±ëŠ¥ ê¸°ì¤€ ì‹¤íŒ¨ ì‹œ PR ìƒíƒœ ì—…ë°ì´íŠ¸
          if (!performanceCheck.passed) {
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'failure',
              context: 'strategy-performance',
              description: 'ì „ëµ ì„±ëŠ¥ ê¸°ì¤€ ë¯¸ë‹¬'
            });
            
            core.setFailed('ë°±í…ŒìŠ¤íŠ¸ ì„±ëŠ¥ ê¸°ì¤€ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          } else {
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'success',
              context: 'strategy-performance',
              description: 'ì „ëµ ì„±ëŠ¥ ê¸°ì¤€ í†µê³¼'
            });
          } 