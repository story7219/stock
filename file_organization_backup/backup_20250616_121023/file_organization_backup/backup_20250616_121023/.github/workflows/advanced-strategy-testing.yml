name: ğŸ§ª ê³ ê¸‰ ì „ëµ í…ŒìŠ¤íŠ¸ & ê²€ì¦

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'strategies/**'
      - 'trading/**'
      - 'trader.py'
  push:
    branches: [main]
  schedule:
    - cron: '0 1 * * 1-5'  # í‰ì¼ ì˜¤ì „ 1ì‹œ ìë™ í…ŒìŠ¤íŠ¸
  workflow_dispatch:

jobs:
  strategy-validation:
    name: ğŸ¯ ì „ëµ ìœ íš¨ì„± ê²€ì¦
    runs-on: ubuntu-latest
    outputs:
      validation-passed: ${{ steps.validate.outputs.passed }}
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-mock
        pip install backtrader zipline-reloaded
        pip install ta-lib quantlib-python
    
    - name: ğŸ” ì „ëµ ì½”ë“œ ê²€ì¦
      id: validate
      run: |
        python .github/scripts/strategy_validator.py
        echo "passed=$(cat validation_result.txt)" >> $GITHUB_OUTPUT

  comprehensive-backtest:
    name: ğŸ“ˆ ì¢…í•© ë°±í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: strategy-validation
    if: needs.strategy-validation.outputs.validation-passed == 'true'
    
    strategy:
      matrix:
        test-period: ['1month', '3months', '6months', '1year']
        market-condition: ['bull', 'bear', 'sideways']
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ë°±í…ŒìŠ¤íŠ¸ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install vectorbt empyrical pyfolio
    
    - name: ğŸ“Š ì‹œì¥ ë°ì´í„° ì¤€ë¹„
      run: |
        python .github/scripts/prepare_test_data.py --period ${{ matrix.test-period }} --condition ${{ matrix.market-condition }}
    
    - name: ğŸš€ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        TEST_PERIOD: ${{ matrix.test-period }}
        MARKET_CONDITION: ${{ matrix.market-condition }}
      run: |
        python .github/scripts/comprehensive_backtest.py
    
    - name: ğŸ“‹ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: backtest-results-${{ matrix.test-period }}-${{ matrix.market-condition }}
        path: |
          backtest_results_*.json
          performance_charts/
          risk_analysis/

  monte-carlo-simulation:
    name: ğŸ² ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜
    runs-on: ubuntu-latest
    needs: strategy-validation
    if: needs.strategy-validation.outputs.validation-passed == 'true'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ì‹œë®¬ë ˆì´ì…˜ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install numpy scipy matplotlib seaborn
    
    - name: ğŸ² ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
      run: |
        python .github/scripts/monte_carlo_simulation.py
    
    - name: ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: monte-carlo-results
        path: |
          monte_carlo_results.json
          simulation_charts/

  stress-testing:
    name: ğŸ’¥ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: strategy-validation
    if: needs.strategy-validation.outputs.validation-passed == 'true'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
    
    - name: ğŸ’¥ ê·¹í•œ ìƒí™© í…ŒìŠ¤íŠ¸
      run: |
        python .github/scripts/stress_test.py
    
    - name: ğŸ“‹ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: stress-test-results
        path: |
          stress_test_results.json
          extreme_scenarios/

  generate-comprehensive-report:
    name: ğŸ“Š ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„±
    runs-on: ubuntu-latest
    needs: [comprehensive-backtest, monte-carlo-simulation, stress-testing]
    if: always()
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ ëª¨ë“  í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v3
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“Š ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„±
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python .github/scripts/generate_comprehensive_report.py
    
    - name: ğŸ“ PR ì½”ë©˜íŠ¸ ì‘ì„±
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let comprehensiveReport = '';
          try {
            comprehensiveReport = fs.readFileSync('comprehensive_test_report.md', 'utf8');
          } catch (e) {
            comprehensiveReport = 'ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨';
          }
          
          // ì„±ëŠ¥ ê¸°ì¤€ ì²´í¬
          let performanceData = {};
          try {
            performanceData = JSON.parse(fs.readFileSync('performance_summary.json', 'utf8'));
          } catch (e) {
            performanceData = { passed: false, error: 'ì„±ëŠ¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨' };
          }
          
          const statusIcon = performanceData.passed ? 'âœ…' : 'âŒ';
          const statusText = performanceData.passed ? 'í†µê³¼' : 'ì‹¤íŒ¨';
          
          const comment = `
          # ğŸ§ª ì¢…í•© ì „ëµ í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ${statusIcon}
          
          ## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
          - **ë°±í…ŒìŠ¤íŠ¸**: ${performanceData.backtest_passed ? 'âœ…' : 'âŒ'}
          - **ëª¬í…Œì¹´ë¥¼ë¡œ ì‹œë®¬ë ˆì´ì…˜**: ${performanceData.monte_carlo_passed ? 'âœ…' : 'âŒ'}
          - **ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸**: ${performanceData.stress_test_passed ? 'âœ…' : 'âŒ'}
          
          ${comprehensiveReport}
          
          ## ğŸ¯ ìµœì¢… íŒì •: **${statusText}**
          
          ${!performanceData.passed ? 'âš ï¸ **ì´ PRì€ ì„±ëŠ¥ ê¸°ì¤€ì„ ë§Œì¡±í•˜ì§€ ì•Šì•„ ë³‘í•©ì´ ì œí•œë©ë‹ˆë‹¤.**' : ''}
          `;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
          // ì„±ëŠ¥ ê¸°ì¤€ ì‹¤íŒ¨ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
          if (!performanceData.passed) {
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'failure',
              context: 'comprehensive-strategy-test',
              description: 'ì „ëµ í…ŒìŠ¤íŠ¸ ê¸°ì¤€ ë¯¸ë‹¬'
            });
            
            core.setFailed('ì¢…í•© ì „ëµ í…ŒìŠ¤íŠ¸ ê¸°ì¤€ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          } else {
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: 'success',
              context: 'comprehensive-strategy-test',
              description: 'ì „ëµ í…ŒìŠ¤íŠ¸ ê¸°ì¤€ í†µê³¼'
            });
          } 