name: ğŸ¯ í”„ë¡œì íŠ¸ ê´€ë¦¬ ìë™í™”

on:
  issues:
    types: [opened, closed, labeled, assigned]
  pull_request:
    types: [opened, closed, merged, labeled, review_requested]
  project_card:
    types: [moved]

jobs:
  auto-project-management:
    name: ğŸ“‹ ìë™ í”„ë¡œì íŠ¸ ê´€ë¦¬
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ¯ ì´ìŠˆ ìë™ ë¶„ë¥˜ ë° í”„ë¡œì íŠ¸ ë³´ë“œ ì¶”ê°€
      if: github.event_name == 'issues' && github.event.action == 'opened'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const issue = context.payload.issue;
          const issueBody = issue.body || '';
          const issueTitle = issue.title.toLowerCase();
          
          // AIë¥¼ í†µí•œ ì´ìŠˆ ìë™ ë¶„ë¥˜
          let labels = [];
          let priority = 'medium';
          let projectColumn = 'To Do';
          
          // í‚¤ì›Œë“œ ê¸°ë°˜ ìë™ ë¼ë²¨ë§
          if (issueTitle.includes('bug') || issueTitle.includes('ì˜¤ë¥˜') || issueTitle.includes('ì—ëŸ¬')) {
            labels.push('bug');
            priority = 'high';
            projectColumn = 'Urgent';
          } else if (issueTitle.includes('feature') || issueTitle.includes('ê¸°ëŠ¥') || issueTitle.includes('ì¶”ê°€')) {
            labels.push('enhancement');
            projectColumn = 'Feature Requests';
          } else if (issueTitle.includes('ì „ëµ') || issueTitle.includes('strategy')) {
            labels.push('strategy');
            labels.push('trading');
            projectColumn = 'Strategy Development';
          } else if (issueTitle.includes('ë°±í…ŒìŠ¤íŠ¸') || issueTitle.includes('backtest')) {
            labels.push('testing');
            labels.push('analysis');
            projectColumn = 'Testing & Analysis';
          }
          
          // ìš°ì„ ìˆœìœ„ ë¼ë²¨ ì¶”ê°€
          labels.push(`priority-${priority}`);
          
          // ë¼ë²¨ ì ìš©
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labels
            });
          }
          
          // í”„ë¡œì íŠ¸ ë³´ë“œì— ìë™ ì¶”ê°€ (í”„ë¡œì íŠ¸ IDëŠ” ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
          try {
            const projects = await github.rest.projects.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            if (projects.data.length > 0) {
              const project = projects.data[0];
              const columns = await github.rest.projects.listColumns({
                project_id: project.id
              });
              
              const targetColumn = columns.data.find(col => 
                col.name.includes(projectColumn) || col.name === 'To do'
              );
              
              if (targetColumn) {
                await github.rest.projects.createCard({
                  column_id: targetColumn.id,
                  content_id: issue.id,
                  content_type: 'Issue'
                });
                
                console.log(`âœ… ì´ìŠˆ #${issue.number}ë¥¼ ${targetColumn.name} ì»¬ëŸ¼ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`);
              }
            }
          } catch (error) {
            console.log(`âš ï¸ í”„ë¡œì íŠ¸ ë³´ë“œ ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`);
          }
          
          // ìë™ í• ë‹¹ (íŠ¹ì • ë¼ë²¨ì— ë”°ë¼)
          if (labels.includes('bug')) {
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              assignees: [context.repo.owner] // ë˜ëŠ” íŠ¹ì • ì‚¬ìš©ì
            });
          }

    - name: ğŸ”„ PR ìƒíƒœ ìë™ ì—…ë°ì´íŠ¸
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const pr = context.payload.pull_request;
          const action = context.payload.action;
          
          // PR ìë™ ë¼ë²¨ë§
          const prTitle = pr.title.toLowerCase();
          const prBody = pr.body || '';
          let labels = [];
          
          if (prTitle.includes('fix') || prTitle.includes('ìˆ˜ì •')) {
            labels.push('bugfix');
          } else if (prTitle.includes('feat') || prTitle.includes('ê¸°ëŠ¥')) {
            labels.push('feature');
          } else if (prTitle.includes('refactor') || prTitle.includes('ë¦¬íŒ©í† ë§')) {
            labels.push('refactoring');
          } else if (prTitle.includes('strategy') || prTitle.includes('ì „ëµ')) {
            labels.push('strategy');
          }
          
          // ë³€ê²½ëœ íŒŒì¼ ê¸°ë°˜ ë¼ë²¨ë§
          const files = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pr.number
          });
          
          const changedFiles = files.data.map(f => f.filename);
          
          if (changedFiles.some(f => f.includes('strategies/'))) {
            labels.push('strategy-change');
          }
          if (changedFiles.some(f => f.includes('tests/'))) {
            labels.push('test-change');
          }
          if (changedFiles.some(f => f.includes('.github/workflows/'))) {
            labels.push('ci-cd');
          }
          
          // ë¼ë²¨ ì ìš©
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: labels
            });
          }
          
          // PR í¬ê¸° ë¶„ì„ ë° ë¼ë²¨ë§
          const totalChanges = files.data.reduce((sum, file) => sum + file.changes, 0);
          let sizeLabel = '';
          
          if (totalChanges < 50) {
            sizeLabel = 'size/small';
          } else if (totalChanges < 200) {
            sizeLabel = 'size/medium';
          } else {
            sizeLabel = 'size/large';
          }
          
          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: pr.number,
            labels: [sizeLabel]
          });
          
          // ëŒ€í˜• PRì— ëŒ€í•œ ê²½ê³  ì½”ë©˜íŠ¸
          if (totalChanges > 500) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `âš ï¸ **ëŒ€í˜• PR ê°ì§€** (${totalChanges} ë³€ê²½ì‚¬í•­)\n\nì´ PRì€ ë§¤ìš° í½ë‹ˆë‹¤. ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”:\n- ë¦¬ë·° ì‹œê°„ ë‹¨ì¶•\n- ë²„ê·¸ ë°œê²¬ ìš©ì´ì„± í–¥ìƒ\n- ì¶©ëŒ ìœ„í—˜ ê°ì†Œ`
            });
          }

  auto-milestone-management:
    name: ğŸ¯ ë§ˆì¼ìŠ¤í†¤ ìë™ ê´€ë¦¬
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
    - name: ğŸ“… ë§ˆì¼ìŠ¤í†¤ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const pr = context.payload.pull_request;
          
          if (pr.milestone) {
            const milestone = await github.rest.issues.getMilestone({
              owner: context.repo.owner,
              repo: context.repo.repo,
              milestone_number: pr.milestone.number
            });
            
            const issues = await github.rest.issues.listForMilestone({
              owner: context.repo.owner,
              repo: context.repo.repo,
              milestone: pr.milestone.number,
              state: 'all'
            });
            
            const totalIssues = issues.data.length;
            const closedIssues = issues.data.filter(issue => issue.state === 'closed').length;
            const progress = Math.round((closedIssues / totalIssues) * 100);
            
            // ë§ˆì¼ìŠ¤í†¤ ì™„ë£Œ ì‹œ ìë™ ì•Œë¦¼
            if (progress === 100) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ğŸ‰ **ë§ˆì¼ìŠ¤í†¤ ì™„ë£Œ!** \n\n"${milestone.data.title}" ë§ˆì¼ìŠ¤í†¤ì´ 100% ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ“Š ì™„ë£Œëœ ì‘ì—…: ${closedIssues}/${totalIssues}`
              });
            }
          } 