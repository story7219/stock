name: ğŸ¤– AI ì½”ë“œ ë¦¬ë·° & ë¦¬íŒ©í† ë§

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ AI ë¶„ì„ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install openai anthropic google-generativeai
        pip install pylint flake8 mypy bandit safety
        pip install radon complexity-report
        pip install ast-grep semgrep
    
    - name: ğŸ” ì½”ë“œ ë³µì¡ë„ ë¶„ì„
      id: complexity
      run: |
        echo "## ğŸ“Š ì½”ë“œ ë³µì¡ë„ ë¶„ì„" >> complexity_report.md
        echo "" >> complexity_report.md
        
        # Radonìœ¼ë¡œ ë³µì¡ë„ ì¸¡ì •
        radon cc . --show-complexity --min B >> complexity_report.md || true
        echo "" >> complexity_report.md
        
        # í•¨ìˆ˜ë³„ ë¼ì¸ ìˆ˜ ë¶„ì„
        echo "### ğŸ“ í•¨ìˆ˜ ê¸¸ì´ ë¶„ì„" >> complexity_report.md
        radon raw . --summary >> complexity_report.md || true
        
        # ì¤‘ë³µ ì½”ë“œ ê²€ì‚¬
        echo "### ğŸ”„ ì¤‘ë³µ ì½”ë“œ ê²€ì‚¬" >> complexity_report.md
        pylint --disable=all --enable=duplicate-code . >> complexity_report.md || true
    
    - name: ğŸ¤– Gemini AI ì½”ë“œ ë¶„ì„
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python .github/scripts/ai_code_analyzer.py
    
    - name: ğŸ”§ ìë™ ë¦¬íŒ©í† ë§ ì œì•ˆ
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python .github/scripts/auto_refactor.py
    
    - name: ğŸ›¡ï¸ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
      run: |
        echo "## ğŸ›¡ï¸ ë³´ì•ˆ ë¶„ì„" >> security_report.md
        bandit -r . -f markdown >> security_report.md || true
        safety check --json >> safety_report.json || true
    
    - name: ğŸ“ AI ë¦¬ë·° ëŒ“ê¸€ ì‘ì„±
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // ë¶„ì„ ê²°ê³¼ ì½ê¸°
          let complexityReport = '';
          let aiAnalysis = '';
          let refactorSuggestions = '';
          
          try {
            complexityReport = fs.readFileSync('complexity_report.md', 'utf8');
          } catch (e) { complexityReport = 'ë¶„ì„ ê²°ê³¼ ì—†ìŒ'; }
          
          try {
            aiAnalysis = fs.readFileSync('ai_analysis.md', 'utf8');
          } catch (e) { aiAnalysis = 'AI ë¶„ì„ ê²°ê³¼ ì—†ìŒ'; }
          
          try {
            refactorSuggestions = fs.readFileSync('refactor_suggestions.md', 'utf8');
          } catch (e) { refactorSuggestions = 'ë¦¬íŒ©í† ë§ ì œì•ˆ ì—†ìŒ'; }
          
          const comment = `
          # ğŸ¤– AI ì½”ë“œ ë¦¬ë·° ë¦¬í¬íŠ¸
          
          ## ğŸ“Š ìë™ ë¶„ì„ ê²°ê³¼
          ${complexityReport}
          
          ## ğŸ§  AI ë¶„ì„ ì˜ê²¬
          ${aiAnalysis}
          
          ## ğŸ”§ ë¦¬íŒ©í† ë§ ì œì•ˆ
          ${refactorSuggestions}
          
          ---
          *ì´ ë¦¬ë·°ëŠ” AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ì°¸ê³ ìš©ìœ¼ë¡œ í™œìš©í•´ì£¼ì„¸ìš”.*
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          }); 