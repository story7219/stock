name: ğŸ“ˆ ì‹¤ë§¤ë§¤ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ

on:
  schedule:
    - cron: '30 0 * * 1-5'    # í‰ì¼ ì˜¤ì „ 9ì‹œ 30ë¶„ (ì¥ ì‹œì‘)
    - cron: '30 6 * * 1-5'    # í‰ì¼ ì˜¤í›„ 3ì‹œ 30ë¶„ (ì¥ ë§ˆê°)
    - cron: '*/15 9-15 * * 1-5' # í‰ì¼ ì¥ì¤‘ 15ë¶„ë§ˆë‹¤
  workflow_dispatch:
    inputs:
      trading_mode:
        description: 'ë§¤ë§¤ ëª¨ë“œ'
        required: true
        default: 'paper'
        type: choice
        options:
        - paper
        - live
      force_rebalance:
        description: 'ê°•ì œ ë¦¬ë°¸ëŸ°ì‹±'
        required: false
        default: false
        type: boolean

jobs:
  pre-market-check:
    name: ğŸŒ… ì¥ì „ ì‹œìŠ¤í…œ ì ê²€
    runs-on: ubuntu-latest
    if: github.event.schedule == '30 0 * * 1-5' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
    
    - name: ğŸ” ì‹œìŠ¤í…œ ìƒíƒœ ì ê²€
      env:
        MOCK_KIS_APP_KEY: ${{ secrets.MOCK_KIS_APP_KEY }}
        MOCK_KIS_APP_SECRET: ${{ secrets.MOCK_KIS_APP_SECRET }}
        MOCK_KIS_ACCOUNT_NUMBER: ${{ secrets.MOCK_KIS_ACCOUNT_NUMBER }}
        LIVE_KIS_APP_KEY: ${{ secrets.LIVE_KIS_APP_KEY }}
        LIVE_KIS_APP_SECRET: ${{ secrets.LIVE_KIS_APP_SECRET }}
        LIVE_KIS_ACCOUNT_NUMBER: ${{ secrets.LIVE_KIS_ACCOUNT_NUMBER }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python .github/scripts/pre_market_check.py
    
    - name: ğŸ“Š ì‹œì¥ ìƒí™© ë¶„ì„
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python .github/scripts/market_analysis.py
    
    - name: ğŸ“‹ ì ê²€ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: pre-market-check
        path: |
          system_status.json
          market_analysis.json
          pre_market_report.md

  live-trading-execution:
    name: ğŸš€ ì‹¤ë§¤ë§¤ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: pre-market-check
    if: github.event.schedule == '*/15 9-15 * * 1-5' || (github.event_name == 'workflow_dispatch' && github.event.inputs.trading_mode == 'live')
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
    
    - name: ğŸš€ ì‹¤ë§¤ë§¤ ì‹¤í–‰
      env:
        LIVE_KIS_APP_KEY: ${{ secrets.LIVE_KIS_APP_KEY }}
        LIVE_KIS_APP_SECRET: ${{ secrets.LIVE_KIS_APP_SECRET }}
        LIVE_KIS_ACCOUNT_NUMBER: ${{ secrets.LIVE_KIS_ACCOUNT_NUMBER }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        IS_MOCK: 'false'
        FORCE_REBALANCE: ${{ github.event.inputs.force_rebalance || 'false' }}
      run: |
        python .github/scripts/live_trading_executor.py
    
    - name: ğŸ“Š ê±°ë˜ ê²°ê³¼ ë¶„ì„
      run: |
        python .github/scripts/trading_result_analyzer.py
    
    - name: ğŸ“‹ ê±°ë˜ ë¡œê·¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: trading-logs-${{ github.run_number }}
        path: |
          trading_logs/
          trading_results.json
          performance_metrics.json

  paper-trading-simulation:
    name: ğŸ“ ëª¨ì˜ë§¤ë§¤ ì‹œë®¬ë ˆì´ì…˜
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.trading_mode == 'paper'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
    
    - name: ğŸ“ ëª¨ì˜ë§¤ë§¤ ì‹¤í–‰
      env:
        MOCK_KIS_APP_KEY: ${{ secrets.MOCK_KIS_APP_KEY }}
        MOCK_KIS_APP_SECRET: ${{ secrets.MOCK_KIS_APP_SECRET }}
        MOCK_KIS_ACCOUNT_NUMBER: ${{ secrets.MOCK_KIS_ACCOUNT_NUMBER }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        IS_MOCK: 'true'
      run: |
        python .github/scripts/paper_trading_executor.py

  anomaly-detection:
    name: ğŸš¨ ì´ìƒ ì§•í›„ íƒì§€
    runs-on: ubuntu-latest
    needs: [live-trading-execution]
    if: always()
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ ê±°ë˜ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v3
      with:
        name: trading-logs-${{ github.run_number }}
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ì´ìƒ íƒì§€ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install scikit-learn isolation-forest
    
    - name: ğŸš¨ ì´ìƒ ì§•í›„ ë¶„ì„
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python .github/scripts/anomaly_detector.py
    
    - name: ğŸ“Š ì´ìƒ íƒì§€ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: anomaly-detection-results
        path: |
          anomaly_report.json
          alert_logs.txt

  post-market-analysis:
    name: ğŸŒ† ì¥í›„ ë¶„ì„
    runs-on: ubuntu-latest
    if: github.event.schedule == '30 6 * * 1-5'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
    
    - name: ğŸ“Š ì¼ì¼ ì„±ê³¼ ë¶„ì„
      env:
        LIVE_KIS_APP_KEY: ${{ secrets.LIVE_KIS_APP_KEY }}
        LIVE_KIS_APP_SECRET: ${{ secrets.LIVE_KIS_APP_SECRET }}
        LIVE_KIS_ACCOUNT_NUMBER: ${{ secrets.LIVE_KIS_ACCOUNT_NUMBER }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python .github/scripts/daily_performance_analysis.py
    
    - name: ğŸ“ˆ ì„±ê³¼ ë¦¬í¬íŠ¸ ìƒì„±
      run: |
        python .github/scripts/generate_daily_report.py
    
    - name: ğŸ“‹ ì¼ì¼ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: daily-report-${{ github.run_number }}
        path: |
          daily_report.html
          performance_charts/
          risk_metrics.json 