name: ğŸ—ï¸ ì½”ë“œ êµ¬ì¡°í™” ìë™í™”

on:
  push:
    branches: [main, develop]
  pull_request:
    types: [opened, synchronize]
  schedule:
    - cron: '0 2 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œ
  workflow_dispatch:

jobs:
  analyze-code-structure:
    name: ğŸ“Š ì½”ë“œ êµ¬ì¡° ë¶„ì„
    runs-on: ubuntu-latest
    outputs:
      restructure-needed: ${{ steps.analysis.outputs.restructure_needed }}
      analysis-results: ${{ steps.analysis.outputs.results }}
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ë¶„ì„ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install radon mccabe pyflakes vulture
        pip install ast-grep semgrep lizard
        pip install google-generativeai openai
    
    - name: ğŸ” ì½”ë“œ êµ¬ì¡° ë¶„ì„ ì‹¤í–‰
      id: analysis
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python .github/scripts/code_structure_analyzer.py
        echo "restructure_needed=$(cat restructure_needed.txt)" >> $GITHUB_OUTPUT
        echo "results=$(cat analysis_summary.json)" >> $GITHUB_OUTPUT
    
    - name: ğŸ“‹ ë¶„ì„ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: structure-analysis
        path: |
          structure_analysis_report.md
          restructure_plan.json
          code_metrics.json

  auto-restructure:
    name: ğŸ”§ ìë™ ë¦¬íŒ©í† ë§
    runs-on: ubuntu-latest
    needs: analyze-code-structure
    if: needs.analyze-code-structure.outputs.restructure-needed == 'true'
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ ë¦¬íŒ©í† ë§ ë„êµ¬ ì„¤ì¹˜
      run: |
        pip install -r requirements.txt
        pip install rope autoflake isort black
        pip install google-generativeai
    
    - name: ğŸ“¥ ë¶„ì„ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v3
      with:
        name: structure-analysis
    
    - name: ğŸ”§ ìë™ ë¦¬íŒ©í† ë§ ì‹¤í–‰
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python .github/scripts/auto_restructure.py
    
    - name: ğŸ“ ë¦¬íŒ©í† ë§ PR ìƒì„±
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ—ï¸ ìë™ ì½”ë“œ êµ¬ì¡°í™” ë¦¬íŒ©í† ë§"
        title: "ğŸ¤– AI ìë™ ì½”ë“œ êµ¬ì¡°í™”"
        body: |
          ## ğŸ—ï¸ ìë™ ì½”ë“œ êµ¬ì¡°í™” ê²°ê³¼
          
          AIê°€ ë¶„ì„í•œ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì½”ë“œë¥¼ ì—­í• ë³„ë¡œ ì¬êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.
          
          ### ğŸ“Š ì£¼ìš” ë³€ê²½ì‚¬í•­
          - ë§¤ë§¤ ì „ëµ ëª¨ë“ˆ ë¶„ë¦¬
          - ë°ì´í„° ìˆ˜ì§‘ ë¡œì§ ë…ë¦½í™”
          - ì£¼ë¬¸ ì‹¤í–‰ ì‹œìŠ¤í…œ ëª¨ë“ˆí™”
          - ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§ ë¶„ë¦¬
          
          ### ğŸ¯ ê°œì„  íš¨ê³¼
          - ì½”ë“œ ê°€ë…ì„± í–¥ìƒ
          - ìœ ì§€ë³´ìˆ˜ì„± ê°œì„ 
          - í…ŒìŠ¤íŠ¸ ìš©ì´ì„± ì¦ëŒ€
          - ëª¨ë“ˆ ì¬ì‚¬ìš©ì„± í–¥ìƒ
          
          *ì´ PRì€ AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ë¦¬ë·° í›„ ë³‘í•©í•´ì£¼ì„¸ìš”.*
        branch: auto-restructure
        delete-branch: true

  sonarqube-analysis:
    name: ğŸ” SonarQube ì½”ë“œ í’ˆì§ˆ ë¶„ì„
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ” SonarQube ìŠ¤ìº”
      uses: sonarqube-quality-gate-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    
    - name: ğŸ“Š í’ˆì§ˆ ê²Œì´íŠ¸ ì²´í¬
      run: |
        echo "SonarQube í’ˆì§ˆ ë¶„ì„ ì™„ë£Œ" 